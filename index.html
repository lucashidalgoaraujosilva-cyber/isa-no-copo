<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>√çsa no Copo | App</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Cores Din√¢micas (Alter√°veis via Config) */
            --hue: 150; /* Verde padr√£o (150) */
            --primaria: hsl(var(--hue), 100%, 35%); 
            --primaria-light: hsl(var(--hue), 100%, 92%);
            --primaria-dark: hsl(var(--hue), 100%, 25%);
            --gradiente: linear-gradient(135deg, hsl(var(--hue), 90%, 40%), hsl(var(--hue), 100%, 30%));
            
            /* Cores de Interface */
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --bg-input: #f1f5f9;
            --texto-titulo: #0f172a;
            --texto-corpo: #475569;
            --texto-suave: #94a3b8;
            --borda: #e2e8f0;
            
            /* Status */
            --vermelho: #ef4444;
            --vermelho-bg: #fee2e2;
            --laranja: #f97316;
            --laranja-bg: #ffedd5;
            --azul: #3b82f6;
            --azul-bg: #dbeafe;
            
            /* Layout */
            --sombra-card: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            --sombra-elevada: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
            --radius: 16px;
            --nav-height: 80px;
        }

        [data-theme="dark"] {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --texto-titulo: #f8fafc;
            --texto-corpo: #cbd5e1;
            --borda: #334155;
            --sombra-card: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-body); color: var(--texto-corpo); padding-bottom: calc(var(--nav-height) + 20px); transition: background 0.3s ease; }
        
        /* HEADER COM EFEITO GLASS */
        header {
            position: sticky; top: 0; z-index: 100;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--borda);
            padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        [data-theme="dark"] header { background: rgba(30, 41, 59, 0.85); }

        .logo-area h1 { margin: 0; font-size: 18px; font-weight: 800; color: var(--primaria); letter-spacing: -0.5px; display: flex; align-items: center; gap: 8px;}
        .status-badge { font-size: 10px; padding: 4px 10px; background: var(--primaria-light); color: var(--primaria-dark); border-radius: 20px; font-weight: 700; text-transform: uppercase; display: flex; align-items: center; gap: 6px; }
        .status-dot { width: 6px; height: 6px; background: var(--primaria); border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; box-shadow: 0 0 0 0 rgba(var(--hue), 0.7); } 70% { opacity: 0.7; box-shadow: 0 0 0 5px rgba(0,0,0,0); } 100% { opacity: 1; } }

        /* CONTAINERS E ANIMA√á√ïES */
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .view-section { display: none; opacity: 0; transform: translateY(10px); transition: all 0.3s ease; }
        .view-section.ativa { display: block; opacity: 1; transform: translateY(0); }

        /* CARDS E FORMUL√ÅRIOS */
        .card-box { background: var(--bg-card); border-radius: var(--radius); padding: 20px; box-shadow: var(--sombra-card); border: 1px solid var(--borda); margin-bottom: 20px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--borda); padding-bottom: 10px; }
        .card-title { font-size: 16px; font-weight: 700; color: var(--texto-titulo); margin: 0; display: flex; align-items: center; gap: 8px; }

        /* INPUTS MODERNOS */
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 12px; font-weight: 600; color: var(--texto-suave); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .form-control { width: 100%; padding: 14px; border-radius: 12px; border: 2px solid transparent; background: var(--bg-input); font-family: inherit; font-size: 15px; color: var(--texto-titulo); transition: 0.2s; }
        .form-control:focus { outline: none; background: var(--bg-card); border-color: var(--primaria); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }

        /* BOT√ïES */
        .btn { border: none; padding: 14px 20px; border-radius: 12px; font-weight: 700; font-size: 14px; cursor: pointer; transition: transform 0.1s, box-shadow 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--gradiente); color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.15); width: 100%; }
        .btn-outline { background: transparent; border: 2px solid var(--borda); color: var(--texto-corpo); }
        .btn-danger { background: var(--vermelho-bg); color: var(--vermelho); }
        .btn-whatsapp { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }

        /* SELE√á√ÉO DE INGREDIENTES (CHIPS) */
        .grid-ingredientes { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; }
        .check-btn { position: relative; }
        .check-btn input { display: none; }
        .check-btn span { display: flex; align-items: center; justify-content: center; padding: 12px 10px; background: var(--bg-input); border-radius: 12px; font-size: 13px; font-weight: 600; color: var(--texto-corpo); border: 2px solid transparent; transition: 0.2s; text-align: center; height: 100%; cursor: pointer; }
        .check-btn input:checked + span { background: var(--primaria-light); color: var(--primaria-dark); border-color: var(--primaria); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

        /* SWITCHER ENTREGA/RETIRADA */
        .toggle-switch { display: flex; background: var(--bg-input); padding: 4px; border-radius: 14px; margin-bottom: 20px; }
        .toggle-btn { flex: 1; padding: 10px; text-align: center; border-radius: 10px; font-weight: 700; font-size: 14px; cursor: pointer; color: var(--texto-suave); transition: 0.3s; }
        .toggle-btn.active { background: var(--bg-card); color: var(--primaria); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }

        /* KANBAN (QUADRO) */
        .kanban-wrapper { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 20px; min-height: 60vh; scroll-snap-type: x mandatory; }
        .kanban-col { min-width: 85vw; scroll-snap-align: center; display: flex; flex-direction: column; gap: 15px; }
        .col-header { background: var(--bg-input); padding: 12px 15px; border-radius: 12px; font-weight: 800; color: var(--texto-titulo); display: flex; justify-content: space-between; align-items: center; font-size: 14px; text-transform: uppercase; }
        .badge-count { background: var(--bg-card); padding: 2px 8px; border-radius: 8px; font-size: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* CART√ÉO DE PEDIDO */
        .order-card { background: var(--bg-card); border-radius: 16px; padding: 16px; box-shadow: var(--sombra-card); border: 1px solid var(--borda); position: relative; overflow: hidden; transition: 0.3s; }
        .order-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--borda); }
        .order-card.status-novos::before { background: var(--laranja); }
        .order-card.status-preparo::before { background: var(--azul); }
        .order-card.status-rota::before { background: var(--primaria); }
        .order-card.priority { border: 2px solid var(--vermelho); animation: pulseBorder 2s infinite; }

        .order-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; cursor: pointer; }
        .order-id { font-size: 12px; font-weight: 800; color: var(--texto-suave); margin-bottom: 4px; }
        .order-name { font-size: 16px; font-weight: 700; color: var(--texto-titulo); margin: 0; }
        
        .tags-row { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px; }
        .tag { font-size: 10px; font-weight: 700; padding: 4px 8px; border-radius: 6px; text-transform: uppercase; }
        .tag-local { background: var(--laranja-bg); color: var(--laranja); }
        .tag-retirada { background: var(--azul-bg); color: var(--azul); }
        .tag-pago { background: var(--primaria-light); color: var(--primaria-dark); }
        .tag-pendente { background: var(--vermelho-bg); color: var(--vermelho); }

        .order-details { margin-top: 10px; border-top: 1px dashed var(--borda); padding-top: 10px; display: none; }
        .order-card.open .order-details { display: block; animation: slideDown 0.3s; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: 0; } }

        /* MENU INFERIOR FLUTUANTE */
        .bottom-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: rgba(255,255,255,0.9); backdrop-filter: blur(15px); border-radius: 24px; padding: 10px 20px; display: flex; justify-content: space-between; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.5); z-index: 1000; }
        [data-theme="dark"] .bottom-nav { background: rgba(30,41,59,0.9); border-color: rgba(255,255,255,0.1); }
        
        .nav-btn { background: none; border: none; color: var(--texto-suave); font-size: 24px; padding: 10px; border-radius: 12px; transition: 0.3s; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .nav-btn span { font-size: 10px; font-weight: 700; }
        .nav-btn.active { color: var(--primaria); background: var(--primaria-light); transform: translateY(-5px); }

        /* PC RESPONSIVO */
        @media (min-width: 1024px) {
            .bottom-nav { display: none; }
            .container { display: grid; grid-template-columns: 380px 1fr; gap: 30px; align-items: start; }
            .view-section { display: block !important; opacity: 1; transform: none; }
            #view-lancamento { position: sticky; top: 100px; max-height: 85vh; overflow-y: auto; }
            #view-config, #view-financeiro, #view-compras { grid-column: 2; display: none !important; }
            .view-section.ativa-pc { display: block !important; }
            .kanban-col { min-width: 300px; }
        }

        /* CUSTOMIZA√á√ÉO DE CORES */
        .color-picker { display: flex; gap: 10px; margin-top: 10px; }
        .color-option { width: 40px; height: 40px; border-radius: 50%; border: 3px solid white; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.2s; }
        .color-option:hover { transform: scale(1.1); }
    </style>
</head>
<body>

<header>
    <div class="logo-area">
        <h1 id="nome-loja-header">ü•ó √çsa no Copo</h1>
        <div class="status-badge"><div class="status-dot"></div> ONLINE</div>
    </div>
    <div style="display: flex; gap: 10px;">
        <button class="btn btn-outline" style="padding: 8px 12px;" onclick="mudarAba('view-config', 'tab-config')">‚öôÔ∏è</button>
    </div>
</header>

<div class="container">

    <div id="view-lancamento" class="view-section ativa">
        <div class="card-box">
            <div id="aviso-edicao" style="display:none; background:var(--azul-bg); color:var(--azul); padding:10px; border-radius:8px; margin-bottom:15px; font-weight:700; text-align:center;">‚úèÔ∏è EDITANDO PEDIDO</div>
            
            <div class="card-header"><h3 class="card-title">üìù Novo Pedido</h3></div>

            <div class="toggle-switch">
                <div class="toggle-btn active" id="btn-entrega" onclick="setTipo('entrega')">üõµ Entrega</div>
                <div class="toggle-btn" id="btn-retirada" onclick="setTipo('retirada')">üèÉ Retirada</div>
            </div>

            <div class="input-group">
                <label>Cliente</label>
                <input type="text" class="form-control" id="nome" placeholder="Nome do cliente">
            </div>
            <div class="input-group">
                <label>WhatsApp</label>
                <input type="tel" class="form-control" id="telefone" placeholder="(00) 00000-0000">
            </div>

            <div id="area-endereco">
                <div class="input-group"><label>Bairro</label><input type="text" class="form-control" id="bairro" placeholder="Bairro"></div>
                <div class="input-group"><label>Endere√ßo</label><input type="text" class="form-control" id="endereco" placeholder="Rua e N√∫mero"></div>
            </div>

            <hr style="border:0; border-top:1px solid var(--borda); margin: 20px 0;">

            <div class="input-group">
                <label>Tamanho</label>
                <select class="form-control" id="tamanho">
                    <option value="Copo 550ml">Copo 550ml (R$ 17,00)</option>
                    <option value="Copo 750ml">Copo 750ml (R$ 22,00)</option>
                </select>
            </div>

            <details open style="margin-bottom: 15px;">
                <summary style="font-weight: 700; cursor: pointer; margin-bottom: 10px;">ü•ó Ingredientes (Clique para abrir)</summary>
                
                <label style="font-size: 11px; font-weight: 800; color: var(--primaria); display: block; margin: 10px 0;">1. BASE (M√ÅX 2)</label>
                <div class="grid-ingredientes">
                    <label class="check-btn"><input type="checkbox" class="chk-base" value="Macarr√£o"><span>Macarr√£o</span></label>
                    <label class="check-btn"><input type="checkbox" class="chk-base" value="Quinoa"><span>Quinoa</span></label>
                    <label class="check-btn"><input type="checkbox" class="chk-base" value="Milho"><span>Milho</span></label>
                    <label class="check-btn"><input type="checkbox" class="chk-base" value="Ervilhas"><span>Ervilhas</span></label>
                </div>

                <label style="font-size: 11px; font-weight: 800; color: var(--primaria); display: block; margin: 10px 0;">2. PROTE√çNA</label>
                <div class="grid-ingredientes">
                    <label class="check-btn"><input type="checkbox" class="chk-prot" value="Frango"><span>Frango</span></label>
                    <label class="check-btn"><input type="checkbox" class="chk-prot" value="Atum"><span>Atum</span></label>
                </div>

                <label style="font-size: 11px; font-weight: 800; color: var(--primaria); display: block; margin: 10px 0;">3. CROC√ÇNCIA</label>
                <div class="grid-ingredientes">
                    <label class="check-btn"><input type="checkbox" class="chk-croc" value="Tomate"><span>Tomate</span></label>
                    <label class="check-btn"><input type="checkbox" class="chk-croc" value="Cenoura"><span>Cenoura</span></label>
                    <label class="check-btn"><input type="checkbox" class="chk-croc" value="Pepino"><span>Pepino</span></label>
                    <label class="check-btn"><input type="checkbox" class="chk-croc" value="Beterraba"><span>Beterraba</span></label>
                    <label class="check-btn"><input type="checkbox" class="chk-croc" value="Palmito"><span>Palmito</span></label>
                    <label class="check-btn"><input type="checkbox" class="chk-croc" value="Cogumelos"><span>Cogumelos (+R$4)</span></label>
                </div>

                <label style="font-size: 11px; font-weight: 800; color: var(--primaria); display: block; margin: 10px 0;">4. FOLHAS</label>
                <div class="grid-ingredientes">
                    <label class="check-btn"><input type="checkbox" class="chk-folha" value="Alface"><span>Alface</span></label>
                    <label class="check-btn"><input type="checkbox" class="chk-folha" value="R√∫cula"><span>R√∫cula</span></label>
                    <label class="check-btn"><input type="checkbox" class="chk-folha" value="Repolho"><span>Repolho</span></label>
                    <label class="check-btn"><input type="checkbox" class="chk-folha" value="Acelga"><span>Acelga</span></label>
                </div>

                <label style="font-size: 11px; font-weight: 800; color: var(--primaria); display: block; margin: 10px 0;">5. MOLHOS E TOQUES</label>
                <div class="grid-ingredientes">
                    <label class="check-btn"><input type="checkbox" class="chk-molho" value="Mostarda/Mel"><span>Mostarda/Mel</span></label>
                    <label class="check-btn"><input type="checkbox" class="chk-molho" value="Ros√©"><span>Ros√©</span></label>
                    <label class="check-btn"><input type="checkbox" class="chk-molho" value="Iogurte"><span>Iogurte</span></label>
                    <label class="check-btn"><input type="checkbox" class="chk-toque" value="Nozes"><span>Nozes (+R$4)</span></label>
                    <label class="check-btn"><input type="checkbox" class="chk-toque" value="Castanha"><span>Castanha (+R$4)</span></label>
                </div>
            </details>

            <button class="btn btn-outline" style="width: 100%; margin-bottom: 15px;" onclick="addCarrinho()">üõí Adicionar Copo ao Pedido</button>

            <div id="carrinho-display" style="display:none; background: var(--bg-input); padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                <h4 style="margin:0 0 10px 0; font-size:13px; color:var(--texto-titulo);">Itens no Pedido: <span id="cart-count">0</span></h4>
                <div id="cart-list"></div>
            </div>

            <div class="input-group">
                <label>Pagamento</label>
                <select class="form-control" id="pagamento">
                    <option value="Pendente">‚ö†Ô∏è Cobrar na Entrega</option>
                    <option value="Pago">‚úÖ J√° Pago (PIX)</option>
                </select>
            </div>

            <div class="input-group">
                <label>Observa√ß√£o / Troco</label>
                <input type="text" class="form-control" id="obs" placeholder="Ex: Troco para 50...">
            </div>

            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                <label class="check-btn" style="flex:1">
                    <input type="checkbox" id="prioridade">
                    <span style="color: var(--vermelho); border-color: var(--vermelho);">üî• URGENTE</span>
                </label>
                <input type="time" class="form-control" id="horario" style="flex:1">
            </div>

            <button class="btn btn-whatsapp" style="width: 100%; margin-bottom: 10px;" onclick="enviarResumo()">üí¨ Enviar Resumo p/ Cliente</button>
            
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-danger" id="btn-cancelar" style="display: none; flex: 1;" onclick="cancelarEdicao()">Cancelar</button>
                <button class="btn btn-primary" id="btn-finalizar" style="flex: 1;" onclick="finalizarPedido()">‚úÖ Lan√ßar Pedido</button>
            </div>
        </div>
    </div>

    <div id="view-entregas" class="view-section">
        <div class="kanban-wrapper">
            <div class="kanban-col" id="col-novos">
                <div class="col-header">üî¥ Fila <span class="badge-count" id="count-novos">0</span></div>
                <div id="list-novos"></div>
            </div>
            <div class="kanban-col" id="col-preparo">
                <div class="col-header">üü° Montando <span class="badge-count" id="count-preparo">0</span></div>
                <div id="list-preparo"></div>
            </div>
            <div class="kanban-col" id="col-rota">
                <div class="col-header">üîµ Rota <span class="badge-count" id="count-rota">0</span></div>
                <div id="list-rota"></div>
            </div>
            <div class="kanban-col" id="col-entregue">
                <div class="col-header">üü¢ Entregues <span class="badge-count" id="count-entregue">0</span></div>
                <div id="list-entregue"></div>
            </div>
        </div>
    </div>

    <div id="view-financeiro" class="view-section ativa-pc">
        <div class="card-box" style="background: var(--gradiente); color: white; text-align: center;">
            <h2 style="font-size: 14px; opacity: 0.9; margin: 0;">CAIXA HOJE</h2>
            <div style="font-size: 42px; font-weight: 800; margin: 10px 0;" id="valor-hoje">R$ 0,00</div>
            <div style="display: flex; justify-content: center; gap: 15px; font-size: 13px;">
                <span id="qtd-hoje">0 Pedidos</span> ‚Ä¢ <span id="itens-hoje">0 Itens</span>
            </div>
        </div>
        
        <div class="card-box">
            <h3 class="card-title">Hist√≥rico Recente</h3>
            <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                <thead style="text-align: left; font-size: 12px; color: var(--texto-suave);">
                    <tr><th style="padding-bottom:10px;">DATA</th><th>PEDIDOS</th><th>TOTAL</th></tr>
                </thead>
                <tbody id="lista-historico" style="font-size: 14px;"></tbody>
            </table>
        </div>
    </div>

    <div id="view-compras" class="view-section ativa-pc">
        <div class="card-box">
            <div class="card-header"><h3 class="card-title">üõí Lista de Compras</h3></div>
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <input type="text" class="form-control" id="novo-compra" placeholder="Item faltando...">
                <button class="btn btn-primary" style="width: auto;" onclick="addCompra()">+</button>
            </div>
            <div id="lista-compras"></div>
        </div>
    </div>

    <div id="view-config" class="view-section">
        <div class="card-box">
            <div class="card-header"><h3 class="card-title">‚öôÔ∏è Ajustes do App</h3></div>
            
            <div class="input-group">
                <label>Nome da Loja</label>
                <input type="text" class="form-control" id="cfg-nome-loja" value="√çsa no Copo" oninput="salvarConfig()">
            </div>

            <div class="input-group">
                <label>Cor do Tema</label>
                <div class="color-picker">
                    <div class="color-option" style="background: #10b981;" onclick="setTheme(150)"></div> <div class="color-option" style="background: #ec4899;" onclick="setTheme(330)"></div> <div class="color-option" style="background: #8b5cf6;" onclick="setTheme(260)"></div> <div class="color-option" style="background: #3b82f6;" onclick="setTheme(210)"></div> <div class="color-option" style="background: #f97316;" onclick="setTheme(25)"></div>  </div>
            </div>

            <div class="input-group">
                <label>Modo Escuro</label>
                <button class="btn btn-outline" style="width: 100%; justify-content: space-between;" onclick="toggleDark()">
                    <span>Alternar Claro/Escuro</span> <span>üåì</span>
                </button>
            </div>

            <hr style="border:0; border-top:1px solid var(--borda); margin: 20px 0;">
            
            <button class="btn btn-danger" style="width: 100%;" onclick="zerarPainel()">üóëÔ∏è LIMPAR DADOS DO DIA (Requer Senha)</button>
        </div>
    </div>

</div>

<nav class="bottom-nav">
    <button class="nav-btn active" id="tab-lancamento" onclick="mudarAba('view-lancamento', 'tab-lancamento')">üìù<span>Novo</span></button>
    <button class="nav-btn" id="tab-entregas" onclick="mudarAba('view-entregas', 'tab-entregas')">üõµ<span>Entregas</span></button>
    <button class="nav-btn" id="tab-financeiro" onclick="mudarAba('view-financeiro', 'tab-financeiro')">üí∞<span>Caixa</span></button>
    <button class="nav-btn" id="tab-compras" onclick="mudarAba('view-compras', 'tab-compras')">üõí<span>Lista</span></button>
</nav>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, onValue, push, set, update, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCL5banCYijxDHRGxQcDZOmnUnHaS_8Omg",
        authDomain: "isa-no-copo-pdv.firebaseapp.com",
        databaseURL: "https://isa-no-copo-pdv-default-rtdb.firebaseio.com",
        projectId: "isa-no-copo-pdv",
        storageBucket: "isa-no-copo-pdv.firebasestorage.app",
        messagingSenderId: "386835506265",
        appId: "1:386835506265:web:154cafa56da36ca14afd48"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ESTADO LOCAL
    let carrinho = [];
    let editandoId = null;
    let dadosCache = {};
    let contador = 1;
    let tipoEntrega = 'entrega';

    // --- SETUP VISUAL ---
    window.setTheme = (hue) => {
        document.documentElement.style.setProperty('--hue', hue);
        localStorage.setItem('isaHue', hue);
    };
    const savedHue = localStorage.getItem('isaHue');
    if(savedHue) window.setTheme(savedHue);

    window.toggleDark = () => {
        const body = document.body;
        if(body.getAttribute('data-theme') === 'dark') {
            body.removeAttribute('data-theme'); localStorage.setItem('isaDark', 'light');
        } else {
            body.setAttribute('data-theme', 'dark'); localStorage.setItem('isaDark', 'dark');
        }
    };
    if(localStorage.getItem('isaDark') === 'dark') document.body.setAttribute('data-theme', 'dark');

    window.mudarAba = (viewId, tabId) => {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('ativa'));
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        // Se for PC, algumas abas n√£o somem
        if(window.innerWidth < 1024) {
            document.getElementById(viewId).classList.add('ativa');
        } else {
            // L√≥gica PC: Se clicar em financeiro ou compras, abre o modal ou rola
            document.getElementById(viewId).classList.add('ativa'); // Simplificado
        }
        if(tabId) document.getElementById(tabId).classList.add('active');
    };

    window.setTipo = (tipo) => {
        tipoEntrega = tipo;
        document.getElementById('btn-entrega').className = tipo === 'entrega' ? 'toggle-btn active' : 'toggle-btn';
        document.getElementById('btn-retirada').className = tipo === 'retirada' ? 'toggle-btn active' : 'toggle-btn';
        document.getElementById('area-endereco').style.display = tipo === 'entrega' ? 'block' : 'none';
        if(tipo === 'retirada') { document.getElementById('bairro').value = 'Balc√£o'; document.getElementById('endereco').value = 'Retirada'; }
        else { if(!editandoId) { document.getElementById('bairro').value = ''; document.getElementById('endereco').value = ''; } }
    };

    window.salvarConfig = () => {
        const nome = document.getElementById('cfg-nome-loja').value;
        document.getElementById('nome-loja-header').innerText = "ü•ó " + nome;
        localStorage.setItem('isaNomeLoja', nome);
    };
    const savedName = localStorage.getItem('isaNomeLoja');
    if(savedName) { document.getElementById('cfg-nome-loja').value = savedName; salvarConfig(); }


    // --- L√ìGICA DE PEDIDOS ---
    
    // Ler Contador
    onValue(ref(db, 'contador'), (snap) => contador = snap.val() || 1);

    // Ler Pedidos e Renderizar Tudo
    onValue(ref(db, 'pedidos'), (snapshot) => {
        dadosCache = snapshot.val() || {};
        renderizarKanban();
        renderizarFinanceiro();
    });

    // Ler Compras
    onValue(ref(db, 'compras'), (snap) => {
        const lista = document.getElementById('lista-compras');
        lista.innerHTML = '';
        const itens = snap.val();
        if(itens) {
            Object.entries(itens).forEach(([k, v]) => {
                lista.innerHTML += `
                    <div class="card-box" style="padding:10px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; opacity: ${v.comprado?0.5:1}">
                        <div onclick="toggleCompra('${k}', ${v.comprado})" style="cursor:pointer; display:flex; gap:10px; align-items:center;">
                            <div style="width:20px; height:20px; border:2px solid var(--borda); border-radius:50%; background:${v.comprado?'var(--primaria)':'transparent'}"></div>
                            <span style="text-decoration:${v.comprado?'line-through':'none'}">${v.nome}</span>
                        </div>
                        <button onclick="delCompra('${k}')" style="background:none; border:none; color:var(--vermelho);">‚úï</button>
                    </div>`;
            });
        }
    });

    // --- FUN√á√ïES DE RENDERIZA√á√ÉO ---
    function renderizarKanban() {
        const cols = { 'novos': [], 'preparo': [], 'rota': [], 'entregue': [] };
        
        Object.entries(dadosCache).forEach(([key, ped]) => {
            const statusKey = ped.status.replace('col-', '');
            if(cols[statusKey]) cols[statusKey].push({ key, ...ped });
        });

        Object.keys(cols).forEach(status => {
            const container = document.getElementById(`list-${status}`);
            const counter = document.getElementById(`count-${status}`);
            container.innerHTML = '';
            counter.innerText = cols[status].length;

            cols[status].forEach(ped => {
                const total = calcTotal(ped);
                const isPendente = ped.pagamento !== 'Pago';
                const tagPag = isPendente ? `<span class="tag tag-pendente">‚ö†Ô∏è R$ ${total}</span>` : `<span class="tag tag-pago">‚úÖ Pago</span>`;
                const tagLocal = ped.tipo === 'retirada' ? `<span class="tag tag-retirada">üèÉ Retira</span>` : `<span class="tag tag-local">üìç ${ped.bairro}</span>`;
                const tagPrioridade = ped.prioridade ? `<span class="tag" style="background:var(--vermelho); color:white;">üî• URG</span>` : '';
                
                let btns = '';
                if(status === 'novos') btns = `<button class="btn btn-outline" onclick="mover('${ped.key}', 'col-preparo')">Iniciar ‚ûî</button>`;
                if(status === 'preparo') btns = `<button class="btn btn-outline" onclick="mover('${ped.key}', 'col-novos')">‚¨ÖÔ∏è</button><button class="btn btn-primary" onclick="mover('${ped.key}', 'col-rota')">${ped.tipo==='retirada'?'Pronto üèÉ':'Saiu üõµ'}</button>`;
                if(status === 'rota') btns = `<button class="btn btn-outline" onclick="mover('${ped.key}', 'col-preparo')">‚¨ÖÔ∏è</button><button class="btn btn-primary" onclick="mover('${ped.key}', 'col-entregue')">Finalizar ‚úîÔ∏è</button>`;
                if(status === 'entregue') btns = `<button class="btn btn-outline" onclick="mover('${ped.key}', 'col-rota')">Voltar</button><button class="btn btn-danger" onclick="delPedido('${ped.key}')">Limpar</button>`;

                const whatsBtn = (ped.tel && status === 'rota') ? `<button class="btn btn-whatsapp" style="padding:8px;" onclick="avisar('${ped.tel}', '${ped.nome}')">üí¨</button>` : '';

                // Renderiza√ß√£o dos Itens
                let itensHtml = '';
                ped.itens.forEach((it, i) => {
                    itensHtml += `<div style="font-size:12px; margin-top:5px; border-bottom:1px dashed var(--borda); padding-bottom:5px;">
                        <strong>${i+1}. ${it.tamanho}</strong><br>
                        <span style="color:var(--texto-suave)">${it.base} | ${it.prot} | ${it.molho}</span>
                    </div>`;
                });

                const html = `
                <div class="order-card status-${status} ${ped.prioridade?'priority':''}" id="card-${ped.key}">
                    <div class="order-header" onclick="toggleDetails('${ped.key}')">
                        <div>
                            <div class="order-id">#${ped.numero}</div>
                            <h4 class="order-name">${ped.nome}</h4>
                        </div>
                        <div style="text-align:right">
                            <div class="tags-row">${tagPrioridade}${tagLocal}</div>
                            <div class="tags-row">${tagPag}</div>
                        </div>
                    </div>
                    <div class="order-details">
                        ${ped.obs ? `<div style="background:var(--laranja-bg); color:var(--laranja); padding:8px; border-radius:8px; font-size:12px; margin-bottom:10px;">üìå ${ped.obs}</div>` : ''}
                        ${itensHtml}
                        <div style="font-size:12px; margin:10px 0;"><strong>End:</strong> ${ped.endereco}</div>
                        <div style="display:flex; gap:10px; margin-top:15px;">
                            ${btns}
                            ${whatsBtn}
                            <button class="btn btn-outline" style="padding:8px;" onclick="editar('${ped.key}')">‚úèÔ∏è</button>
                        </div>
                    </div>
                </div>`;
                container.innerHTML += html;
            });
        });
    }

    function renderizarFinanceiro() {
        const historico = {};
        const hoje = new Date().toLocaleDateString('pt-BR');
        
        Object.values(dadosCache).forEach(ped => {
            const data = ped.data || hoje;
            if(!historico[data]) historico[data] = { total: 0, qtd: 0, itens: 0 };
            historico[data].total += calcTotal(ped);
            historico[data].qtd++;
            historico[data].itens += ped.itens.length;
        });

        const dadosHoje = historico[hoje] || { total: 0, qtd: 0, itens: 0 };
        document.getElementById('valor-hoje').innerText = `R$ ${dadosHoje.total},00`;
        document.getElementById('qtd-hoje').innerText = `${dadosHoje.qtd} Pedidos`;
        document.getElementById('itens-hoje').innerText = `${dadosHoje.itens} Itens`;

        const lista = document.getElementById('lista-historico');
        lista.innerHTML = '';
        Object.keys(historico).sort((a,b) => b.localeCompare(a)).forEach(dt => {
            if(dt !== hoje) {
                lista.innerHTML += `<tr><td style="padding:10px 0;">${dt}</td><td>${historico[dt].qtd}</td><td style="font-weight:700">R$ ${historico[dt].total}</td></tr>`;
            }
        });
    }

    // --- FUN√á√ïES DE C√ÅLCULO ---
    function calcTotal(ped) {
        let total = ped.tipo === 'entrega' ? 4 : 0;
        ped.itens.forEach(it => {
            total += it.tamanho.includes('750') ? 22 : 17;
            if(it.extras) {
                if(it.extras.includes('Nozes')) total += 4;
                if(it.extras.includes('Castanha')) total += 4;
                if(it.extras.includes('Cogumelos')) total += 4;
            }
        });
        return total;
    }

    // --- OPERA√á√ïES DO USU√ÅRIO ---
    window.addCarrinho = () => {
        const tam = document.getElementById('tamanho').value;
        const get = (cls) => Array.from(document.querySelectorAll('.'+cls+':checked')).map(x=>x.value).join(', ');
        const getRaw = (cls) => Array.from(document.querySelectorAll('.'+cls+':checked')).map(x=>x.value).join(' '); // Para busca de extras
        
        // Verifica extras pagos
        const todosIngredientes = getRaw('chk-croc') + ' ' + getRaw('chk-toque');
        
        carrinho.push({
            tamanho: tam,
            base: get('chk-base'), prot: get('chk-prot'), molho: get('chk-molho'),
            extras: todosIngredientes // Para calcular pre√ßo
        });

        // Reset visual
        document.querySelectorAll('input[type="checkbox"]').forEach(c => { if(c.id !== 'prioridade') c.checked = false; });
        document.getElementById('carrinho-display').style.display = 'block';
        document.getElementById('cart-count').innerText = carrinho.length;
        document.getElementById('cart-list').innerHTML = carrinho.map((c,i) => `<div style="font-size:12px; margin-top:5px;">${i+1}. ${c.tamanho} (${c.prot})</div>`).join('');
    };

    window.finalizarPedido = () => {
        const nome = document.getElementById('nome').value;
        if(!nome || carrinho.length === 0) return alert('Preencha nome e adicione itens!');
        
        const payload = {
            nome, 
            tel: document.getElementById('telefone').value,
            bairro: document.getElementById('bairro').value,
            endereco: document.getElementById('endereco').value,
            pagamento: document.getElementById('pagamento').value,
            obs: document.getElementById('obs').value,
            prioridade: document.getElementById('prioridade').checked,
            horario: document.getElementById('horario').value,
            tipo: tipoEntrega,
            itens: carrinho,
            status: 'col-novos',
            numero: editandoId ? dadosCache[editandoId].numero : contador,
            data: new Date().toLocaleDateString('pt-BR'),
            timestamp: Date.now()
        };

        if(editandoId) {
            update(ref(db, 'pedidos/'+editandoId), payload);
            window.cancelarEdicao();
        } else {
            push(ref(db, 'pedidos'), payload);
            set(ref(db, 'contador'), contador + 1);
            limparForm();
        }
        alert('‚úÖ Sucesso!');
    };

    window.editar = (key) => {
        const ped = dadosCache[key];
        editandoId = key;
        
        document.getElementById('nome').value = ped.nome;
        document.getElementById('telefone').value = ped.tel;
        document.getElementById('obs').value = ped.obs;
        document.getElementById('pagamento').value = ped.pagamento;
        document.getElementById('prioridade').checked = ped.prioridade;
        document.getElementById('horario').value = ped.horario;
        window.setTipo(ped.tipo);
        if(ped.tipo === 'entrega') {
            document.getElementById('bairro').value = ped.bairro;
            document.getElementById('endereco').value = ped.endereco;
        }
        
        carrinho = ped.itens;
        document.getElementById('carrinho-display').style.display = 'block';
        document.getElementById('cart-count').innerText = carrinho.length;
        document.getElementById('cart-list').innerHTML = carrinho.map((c,i) => `<div style="font-size:12px; margin-top:5px;">${i+1}. ${c.tamanho} (${c.prot})</div>`).join('');

        document.getElementById('aviso-edicao').style.display = 'block';
        document.getElementById('btn-cancelar').style.display = 'block';
        document.getElementById('btn-finalizar').innerText = 'üíæ Salvar Altera√ß√µes';
        window.mudarAba('view-lancamento', 'tab-lancamento');
        window.scrollTo(0,0);
    };

    window.cancelarEdicao = () => {
        editandoId = null;
        limparForm();
        document.getElementById('aviso-edicao').style.display = 'none';
        document.getElementById('btn-cancelar').style.display = 'none';
        document.getElementById('btn-finalizar').innerText = '‚úÖ Lan√ßar Pedido';
    };

    function limparForm() {
        document.getElementById('nome').value = '';
        document.getElementById('telefone').value = '';
        document.getElementById('obs').value = '';
        document.getElementById('horario').value = '';
        document.getElementById('prioridade').checked = false;
        carrinho = [];
        document.getElementById('carrinho-display').style.display = 'none';
        if(tipoEntrega==='entrega') { document.getElementById('bairro').value=''; document.getElementById('endereco').value=''; }
    }

    // --- FUN√á√ïES DE A√á√ÉO ---
    window.mover = (k,s) => update(ref(db, 'pedidos/'+k), {status:s});
    window.delPedido = (k) => { if(confirm('Excluir?')) remove(ref(db, 'pedidos/'+k)); };
    window.toggleDetails = (id) => document.getElementById('card-'+id).classList.toggle('open');
    window.avisar = (tel, nome) => {
        const num = tel.replace(/\D/g, '');
        window.open(`https://wa.me/55${num}?text=${encodeURIComponent(`Ol√° ${nome}, seu pedido saiu para entrega! üõµ`)}`, '_blank');
    };

    // --- ENVIAR RESUMO (WHATSAPP) ---
    window.enviarResumo = () => {
        if(!carrinho.length) return alert('Carrinho vazio!');
        const nome = document.getElementById('nome').value;
        const tel = document.getElementById('telefone').value.replace(/\D/g, '');
        if(!tel) return alert('Telefone obrigat√≥rio!');

        let msg = `*üßæ CONFER√äNCIA - √çSA NO COPO*\n\n*Cliente:* ${nome}\n`;
        carrinho.forEach((it, i) => {
            msg += `\n*Item ${i+1}:* ${it.tamanho}\nBase: ${it.base}\nProt: ${it.prot}\nMolho: ${it.molho}\n`;
        });
        
        let total = 0;
        const end = document.getElementById('endereco').value;
        if(tipoEntrega==='entrega') total += 4;
        carrinho.forEach(it => {
            total += it.tamanho.includes('750') ? 22 : 17;
            if(it.extras.includes('Nozes') || it.extras.includes('Castanha') || it.extras.includes('Cogumelos')) total += 4; // Simplificado para resumo
        });

        msg += `\n*Tipo:* ${tipoEntrega==='entrega'?'Entrega':'Retirada'}\n*End:* ${end}\n*Total:* R$ ${total},00\n\nConfere se est√° tudo certo?`;
        window.open(`https://wa.me/55${tel}?text=${encodeURIComponent(msg)}`, '_blank');
    };

    // --- LIMPEZA SEGURA ---
    window.zerarPainel = () => {
        const senha = prompt("üîí Senha de Seguran√ßa:");
        if(senha === '140520') {
            set(ref(db, 'pedidos'), null);
            set(ref(db, 'contador'), 1);
            alert('Dia finalizado com sucesso!');
        } else if(senha !== null) {
            alert('‚õî Senha incorreta');
        }
    };

    // --- COMPRAS ---
    window.addCompra = () => {
        const val = document.getElementById('novo-compra').value;
        if(val) { push(ref(db, 'compras'), { nome: val, comprado: false }); document.getElementById('novo-compra').value=''; }
    };
    window.toggleCompra = (k, v) => update(ref(db, 'compras/'+k), { comprado: !v });
    window.delCompra = (k) => remove(ref(db, 'compras/'+k));

    // M√ÅSCARA TEL
    document.getElementById('telefone').addEventListener('input', function (e) {
        let x = e.target.value.replace(/\D/g, '').match(/(\d{0,2})(\d{0,5})(\d{0,4})/);
        e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
    });
    
    // Checkbox Limit
    document.querySelectorAll('.chk-base').forEach(c => c.addEventListener('change', function() {
        if(document.querySelectorAll('.chk-base:checked').length > 2) { this.checked = false; alert('M√°ximo 2 bases!'); }
    }));

</script>
</body>
</html>
