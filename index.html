<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV √çsa no Copo - Seguro e Conectado</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        :root {
            --primaria: #10b981;
            --primaria-hover: #059669;
            --fundo-body: #f3f4f6;
            --fundo-card: #ffffff;
            --fundo-coluna: #f8fafc;
            --texto-principal: #1f2937;
            --texto-secundario: #4b5563;
            --borda: #e5e7eb;
            --borda-foco: #a7f3d0;
            --fundo-input: #f9fafb;
            --laranja: #f59e0b;
            --vermelho: #ef4444;
            --vermelho-fundo: #fef2f2;
            --azul: #3b82f6;
            --verde-whats: #25D366;
            --tag-bairro-bg: #fef3c7;
            --tag-bairro-text: #b45309;
            --tag-retirada-bg: #dbeafe;
            --tag-retirada-text: #1e40af;
            --tag-prioridade-bg: #fee2e2;
            --tag-prioridade-text: #991b1b;
            --tag-horario-bg: #e0e7ff;
            --tag-horario-text: #3730a3;
            --lista-bg: #ecfdf5;
            --lista-text: #047857;
            --sombra: 0 4px 6px -1px rgba(0,0,0,0.05);
            --altura-nav: 70px;
        }

        [data-theme="dark"] {
            --fundo-body: #0f172a;
            --fundo-card: #1e293b;
            --fundo-coluna: #0f172a;
            --texto-principal: #f8fafc;
            --texto-secundario: #94a3b8;
            --borda: #334155;
            --borda-foco: #059669;
            --fundo-input: #0f172a;
            --vermelho-fundo: #450a0a;
            --tag-bairro-bg: #78350f;
            --tag-bairro-text: #fde68a;
            --tag-retirada-bg: #1e3a8a;
            --tag-retirada-text: #bfdbfe;
            --tag-prioridade-bg: #7f1d1d;
            --tag-prioridade-text: #fecaca;
            --tag-horario-bg: #312e81;
            --tag-horario-text: #c7d2fe;
            --lista-bg: #064e3b;
            --lista-text: #6ee7b7;
            --sombra: 0 4px 6px -1px rgba(0,0,0,0.3);
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--fundo-body); color: var(--texto-principal); margin: 0; padding: 0; padding-bottom: var(--altura-nav); transition: 0.3s; }

        header { background: var(--fundo-card); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--borda); position: sticky; top: 0; z-index: 100; }
        header h1 { margin: 0; font-size: 18px; color: var(--primaria); display: flex; align-items: center; gap: 8px; }
        .controles-header { display: flex; gap: 8px; align-items: center; }
        
        .status-nuvem { font-size: 11px; font-weight: bold; color: var(--primaria); display: flex; align-items: center; gap: 5px; background: var(--lista-bg); padding: 6px 10px; border-radius: 20px;}
        .status-nuvem span { display: inline-block; width: 8px; height: 8px; background: var(--primaria); border-radius: 50%; animation: piscar 2s infinite; }
        @keyframes piscar { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        .btn-acao { background: var(--fundo-card); color: var(--texto-principal); border: 1px solid var(--borda); padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; transition: 0.2s; }
        .btn-acao:hover { background: var(--fundo-body); }
        .btn-limpar { color: var(--vermelho); border-color: var(--vermelho); }
        .btn-limpar:hover { background: var(--vermelho-fundo); }

        .container-master { padding: 20px; max-width: 1600px; margin: auto; display: flex; flex-direction: column; gap: 20px; }
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.ativa { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Estilos Financeiro */
        .card-resumo-dia { background: linear-gradient(135deg, var(--primaria), #059669); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3); margin-bottom: 20px; text-align: center; }
        .card-resumo-dia h2 { margin: 0; font-size: 14px; opacity: 0.9; font-weight: 500; text-transform: uppercase; letter-spacing: 1px; }
        .valor-total { font-size: 36px; font-weight: 800; margin: 10px 0; }
        .detalhes-dia { display: flex; justify-content: center; gap: 20px; font-size: 13px; opacity: 0.9; }
        
        .tabela-historico { width: 100%; border-collapse: collapse; background: var(--fundo-card); border-radius: 12px; overflow: hidden; box-shadow: var(--sombra); border: 1px solid var(--borda); }
        .tabela-historico th, .tabela-historico td { padding: 15px; text-align: left; border-bottom: 1px solid var(--borda); font-size: 14px; }
        .tabela-historico th { background: var(--fundo-coluna); color: var(--texto-secundario); font-weight: 600; text-transform: uppercase; font-size: 12px; }
        .tabela-historico tr:last-child td { border-bottom: none; }
        .valor-linha { font-weight: 700; color: var(--primaria); }

        /* Formul√°rio */
        .pdv-container { background: var(--fundo-card); padding: 20px; border-radius: 12px; box-shadow: var(--sombra); border: 1px solid var(--borda); margin-bottom: 20px;}
        .pdv-titulo { font-size: 15px; color: var(--texto-principal); margin-top: 0; border-bottom: 1px solid var(--borda); padding-bottom: 10px; margin-bottom: 20px; text-transform: uppercase; font-weight: 700; display: flex; justify-content: space-between;}
        
        .aviso-edicao { display: none; background: #eff6ff; color: #1e40af; border: 1px solid #bfdbfe; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; font-weight: 600; text-align: center; }
        .aviso-edicao.ativo { display: block; }

        .tipo-entrega-switch { display: flex; gap: 10px; margin-bottom: 20px; background: var(--fundo-body); padding: 5px; border-radius: 10px; }
        .btn-switch { flex: 1; border: none; padding: 10px; border-radius: 8px; background: transparent; color: var(--texto-secundario); font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-switch.ativo { background: var(--fundo-card); color: var(--primaria); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        .dados-cliente { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 25px; }
        .input-group { display: flex; flex-direction: column; flex: 1; min-width: 160px; }
        .input-group label { font-size: 13px; font-weight: 600; color: var(--texto-secundario); margin-bottom: 6px; }
        .dados-cliente input, .dados-cliente select { padding: 14px 15px; border: 1px solid var(--borda); border-radius: 8px; font-size: 15px; background-color: var(--fundo-input); color: var(--texto-principal); transition: 0.2s; }
        .dados-cliente input:focus, .dados-cliente select:focus { outline: none; border-color: var(--primaria); box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1); }

        .checkbox-btn-wrapper input { display: none; }
        .checkbox-btn-wrapper label {
            display: flex; align-items: center; justify-content: center; gap: 8px;
            padding: 14px; border: 1px solid var(--vermelho); color: var(--vermelho);
            border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 14px; transition: 0.2s;
            background: var(--vermelho-fundo); height: 100%; box-sizing: border-box;
        }
        .checkbox-btn-wrapper input:checked + label { background: var(--vermelho); color: white; box-shadow: 0 2px 5px rgba(239, 68, 68, 0.4); }

        .cardapio-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .categoria-menu { background: var(--fundo-body); border: 1px solid var(--borda); border-radius: 10px; padding: 15px; }
        .categoria-menu h4 { margin: 0 0 12px 0; font-size: 13px; color: var(--texto-secundario); font-weight: 700; text-transform: uppercase; }
        
        .chips-container { display: flex; flex-wrap: wrap; gap: 10px; }
        .chip-label { position: relative; display: inline-block; cursor: pointer; user-select: none; }
        .chip-label input { display: none; } 
        .chip-label span { display: inline-block; padding: 12px 14px; border-radius: 20px; border: 1px solid var(--borda); font-size: 14px; background: var(--fundo-card); color: var(--texto-secundario); font-weight: 500; transition: 0.2s; }
        .chip-label input:checked + span { background: var(--primaria); color: white; border-color: var(--primaria); box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3); }

        .carrinho-area { background: var(--lista-bg); border: 1px solid var(--primaria); border-radius: 10px; padding: 15px; margin-top: 20px; }
        .carrinho-titulo { font-size: 14px; font-weight: 700; color: var(--lista-text); margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;}
        .item-carrinho { background: white; padding: 10px; border-radius: 6px; margin-bottom: 8px; font-size: 13px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--borda); }
        .btn-rm-item { color: var(--vermelho); background: none; border: none; font-weight: bold; cursor: pointer; padding: 5px; }

        .rodape-pdv { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .btn-add-item { background: white; color: var(--primaria); border: 2px solid var(--primaria); padding: 14px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 15px; width: 100%; transition: 0.2s; }
        .btn-add-item:hover { background: var(--lista-bg); }
        
        .btn-finalizar { background: var(--primaria); color: white; border: none; padding: 16px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 16px; width: 100%; transition: 0.2s; box-shadow: 0 4px 6px rgba(16, 185, 129, 0.2); opacity: 0.5; pointer-events: none; }
        .btn-finalizar.ativo { opacity: 1; pointer-events: all; }
        .btn-finalizar:hover { background: var(--primaria-hover); transform: translateY(-2px); }
        
        /* Bot√£o WhatsApp Resumo */
        .btn-resumo-zap { background: rgba(37, 211, 102, 0.1); color: var(--verde-whats); border: 1px solid rgba(37, 211, 102, 0.3); padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-resumo-zap:hover { background: var(--verde-whats); color: white; }

        .btn-salvar-edicao { background: var(--azul); }
        .btn-salvar-edicao:hover { background: #2563eb; }
        .btn-cancelar { background: var(--vermelho-fundo); color: var(--vermelho); border: 1px solid var(--vermelho); padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600; display: none; width: 100%; }

        .lista-compras-container { max-width: 600px; margin: auto; }
        .add-item-row { display: flex; gap: 10px; margin-bottom: 20px; }
        .add-item-row input { flex: 1; padding: 12px; border: 1px solid var(--borda); border-radius: 8px; background: var(--fundo-input); color: var(--texto-principal); }
        .btn-add-shop { background: var(--azul); color: white; border: none; padding: 0 20px; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .item-compra { background: var(--fundo-card); padding: 15px; border-radius: 8px; border: 1px solid var(--borda); margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .item-compra.comprado { opacity: 0.5; text-decoration: line-through; }
        .btn-check-compra { background: transparent; border: 2px solid var(--borda); width: 24px; height: 24px; border-radius: 50%; cursor: pointer; margin-right: 10px; display: flex; align-items: center; justify-content: center; color: transparent;}
        .item-compra.comprado .btn-check-compra { background: var(--primaria); border-color: var(--primaria); color: white; }

        .kanban-board { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 20px; min-height: 60vh; scroll-snap-type: x mandatory; }
        .kanban-col { background: var(--fundo-coluna); border-radius: 12px; width: 85vw; max-width: 340px; min-width: 300px; padding: 15px; display: flex; flex-direction: column; gap: 15px; border: 1px solid var(--borda); scroll-snap-align: center; }
        .kanban-col h3 { margin: 0 0 10px 0; font-size: 14px; font-weight: 700; padding-bottom: 10px; border-bottom: 2px solid var(--borda); text-transform: uppercase; color: var(--texto-principal); display: flex; justify-content: space-between; align-items: center; }
        .badge-qtd { background: var(--borda); color: var(--texto-secundario); padding: 2px 8px; border-radius: 12px; font-size: 12px; }

        .pedido-card { background: var(--fundo-card); padding: 15px; border-radius: 10px; box-shadow: var(--sombra); border: 1px solid var(--borda); border-left: 5px solid var(--laranja); transition: 0.3s; display: flex; flex-direction: column; gap: 10px; }
        .pedido-card.prioridade { border: 2px solid var(--vermelho); animation: pulseBorder 2s infinite; }
        @keyframes pulseBorder { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        .card-topo { cursor: pointer; display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 5px; }
        .id-pedido { font-size: 18px; font-weight: 900; color: var(--texto-secundario); margin-right: 8px; }
        
        .bairro-tag { display: inline-block; background: var(--tag-bairro-bg); color: var(--tag-bairro-text); padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; margin-bottom: 6px; text-transform: uppercase; }
        .retirada-tag { display: inline-block; background: var(--tag-retirada-bg); color: var(--tag-retirada-text); padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; margin-bottom: 6px; text-transform: uppercase; }
        .prioridade-tag { display: inline-block; background: var(--tag-prioridade-bg); color: var(--tag-prioridade-text); padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; margin-bottom: 6px; text-transform: uppercase; }
        .horario-tag { display: inline-block; background: var(--tag-horario-bg); color: var(--tag-horario-text); padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; margin-bottom: 6px; text-transform: uppercase; }

        .card-topo h4 { margin: 0; font-size: 16px; font-weight: 700; color: var(--texto-principal); }
        .card-detalhes { overflow: hidden; transition: max-height 0.3s ease; }
        .pedido-card.minimizado .card-detalhes { display: none; }
        .icone-toggle { color: var(--texto-secundario); font-size: 12px; transition: 0.3s; padding-top: 5px; }
        .pedido-card.minimizado .icone-toggle { transform: rotate(-90deg); }

        .badges-pagamento { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap;}
        .badge-pago { background: rgba(34, 197, 94, 0.15); color: #166534; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; border: 1px solid rgba(34, 197, 94, 0.3); }
        .badge-pendente { background: rgba(239, 68, 68, 0.15); color: #991b1b; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; border: 1px solid rgba(239, 68, 68, 0.3); }
        .obs-destaque { background: #fef3c7; color: #b45309; padding: 10px; border-radius: 8px; font-size: 13px; margin: 10px 0; border-left: 4px solid var(--laranja); font-weight: 500; }

        .lista-montagem { background: var(--lista-bg); padding: 12px; border-radius: 8px; margin: 10px 0; font-size: 13px; line-height: 1.6; color: var(--lista-text); border: 1px solid var(--borda-foco); }
        .item-resumo { border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 8px; margin-bottom: 8px; }
        .item-resumo:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .titulo-item { font-weight: 800; text-transform: uppercase; margin-bottom: 4px; display: block; color: var(--primaria-hover); }

        .grid-botoes-contato { display: flex; gap: 8px; margin-top: 10px; }
        .btn-link { flex: 1; display: flex; justify-content: center; align-items: center; gap: 5px; text-decoration: none; padding: 10px; border-radius: 8px; font-size: 13px; font-weight: 600; transition: 0.2s; border: 1px solid transparent; }
        .btn-mapa { background: rgba(59, 130, 246, 0.1); color: var(--azul); border-color: rgba(59, 130, 246, 0.2); }
        .btn-whats { background: rgba(37, 211, 102, 0.1); color: var(--verde-whats); border-color: rgba(37, 211, 102, 0.2); }

        .acoes-card { display: flex; gap: 8px; padding-top: 5px; margin-top: 5px; border-top: 1px solid var(--borda); }
        .btn-mover { background: transparent; border: 1px solid var(--primaria); color: var(--primaria); padding: 12px; border-radius: 8px; cursor: pointer; flex: 1; font-size: 14px; font-weight: 600; transition: 0.2s; }
        .btn-mover:hover { background: var(--primaria); color: white; }
        .btn-voltar { background: transparent; border: 1px solid var(--texto-secundario); color: var(--texto-secundario); padding: 12px; border-radius: 8px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; width: 45px; margin-right: 0px; }
        .btn-voltar:hover { background: #e5e7eb; color: var(--texto-principal); }
        .btn-editar { background: transparent; border: 1px solid var(--borda); color: var(--azul); padding: 12px; border-radius: 8px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; width: 45px;}
        .btn-editar:hover { background: #eff6ff; border-color: var(--azul); }
        .btn-remover { background: transparent; border: 1px solid var(--borda); color: var(--texto-secundario); padding: 12px; border-radius: 8px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; width: 45px;}

        /* Menu Inferior */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--fundo-card); border-top: 1px solid var(--borda); display: flex; justify-content: space-around; padding: 8px 10px; z-index: 1000; box-shadow: 0 -4px 10px rgba(0,0,0,0.05); transition: 0.3s;}
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; background: transparent; border: none; padding: 8px; border-radius: 10px; color: var(--texto-secundario); cursor: pointer; transition: 0.2s; }
        .nav-item span:first-child { font-size: 20px; }
        .nav-item span:last-child { font-size: 12px; font-weight: 600; }
        .nav-item.ativo { color: var(--primaria); background: var(--lista-bg); }

        @media (min-width: 1024px) {
            body { padding-bottom: 0; }
            .bottom-nav { display: none; }
            .container-master { flex-direction: row; align-items: flex-start; }
            .view-section { display: block !important; } 
            #view-lancamento { flex: 0 0 350px; position: sticky; top: 90px; height: calc(100vh - 120px); overflow-y: auto; }
            #view-financeiro, #view-compras { display: none; } 
            #view-entregas { flex: 1; overflow-hidden; }
            .view-section.ativa-pc { display: block !important; position: absolute; z-index: 2000; background: white; top: 80px; left: 50%; transform: translateX(-50%); width: 600px; height: auto; box-shadow: 0 0 20px rgba(0,0,0,0.2); border-radius: 12px; }
            
            .btn-add, .btn-finalizar, .btn-cancelar { width: auto; }
        }
        
        #view-lancamento::-webkit-scrollbar { width: 6px; }
        #view-lancamento::-webkit-scrollbar-thumb { background: var(--borda); border-radius: 10px; }
    </style>
</head>
<body>

    <header>
        <h1>ü•ó √çsa no Copo</h1>
        <div class="controles-header">
            <div class="status-nuvem"><span></span> Online</div>
            <button class="btn-acao" onclick="toggleTema()" id="btn-tema">üåô</button>
            <button class="btn-acao btn-limpar" onclick="zerarPainel()">üóëÔ∏è Finalizar Dia</button>
        </div>
    </header>

    <div class="container-master">
        
        <div id="view-lancamento" class="view-section ativa">
            <div class="pdv-container">
                <div id="aviso-edicao" class="aviso-edicao">‚úèÔ∏è MODO DE EDI√á√ÉO ATIVO</div>
                <h3 class="pdv-titulo">üìã Cliente e Entrega</h3>
                
                <div class="tipo-entrega-switch">
                    <button class="btn-switch ativo" id="btn-entrega" onclick="setTipoEntrega('entrega')">üõµ Entrega</button>
                    <button class="btn-switch" id="btn-retirada" onclick="setTipoEntrega('retirada')">üèÉ Retirada</button>
                </div>

                <div class="dados-cliente">
                    <div class="input-group">
                        <label>Nome do Cliente</label>
                        <input type="text" id="nome" placeholder="Ex: Jo√£o" autocomplete="off">
                    </div>
                    <div class="input-group">
                        <label>WhatsApp</label>
                        <input type="tel" id="telefone" placeholder="(00) 00000-0000" maxlength="15">
                    </div>
                    
                    <div class="input-group grupo-endereco">
                        <label>Bairro</label>
                        <input type="text" id="bairro" placeholder="Ex: Centro" autocomplete="off">
                    </div>
                    <div class="input-group grupo-endereco" style="flex: 2;">
                        <label>Endere√ßo e N√∫mero</label>
                        <input type="text" id="endereco" placeholder="Rua das Flores, 123" autocomplete="off">
                    </div>
                </div>

                <hr style="border: 0; border-top: 1px solid var(--borda); margin: 20px 0;">

                <h3 class="pdv-titulo">ü•ó Montar Item</h3>
                <div class="dados-cliente">
                    <div class="input-group">
                        <label>Tamanho do Copo</label>
                        <select id="tamanho">
                            <option value="Copo 550ml">Copo 550ml (R$ 17,00)</option>
                            <option value="Copo 750ml">Copo 750ml (R$ 22,00)</option>
                        </select>
                    </div>
                </div>

                <div class="cardapio-grid">
                    <div class="categoria-menu">
                        <h4>1. Base (M√°x 2)</h4>
                        <div class="chips-container">
                            <label class="chip-label"><input type="checkbox" class="chk-base" value="Macarr√£o Gelado"><span>Macarr√£o</span></label>
                            <label class="chip-label"><input type="checkbox" class="chk-base" value="Quinoa Real"><span>Quinoa</span></label>
                            <label class="chip-label"><input type="checkbox" class="chk-base" value="Milho Doce"><span>Milho</span></label>
                            <label class="chip-label"><input type="checkbox" class="chk-base" value="Ervilhas"><span>Ervilhas</span></label>
                        </div>
                    </div>
                    <div class="categoria-menu">
                        <h4>2. Prote√≠na</h4>
                        <div class="chips-container">
                            <label class="chip-label"><input type="checkbox" class="chk-prot" value="Frango Desfiado"><span>Frango</span></label>
                            <label class="chip-label"><input type="checkbox" class="chk-prot" value="Atum"><span>Atum</span></label>
                        </div>
                    </div>
                    <div class="categoria-menu">
                        <h4>3. Croc√¢ncia</h4>
                        <div class="chips-container">
                            <label class="chip-label"><input type="checkbox" class="chk-croc" value="Tomate Cereja"><span>Tomate</span></label>
                            <label class="chip-label"><input type="checkbox" class="chk-croc" value="Cenoura Ralada"><span>Cenoura</span></label>
                            <label class="chip-label"><input type="checkbox" class="chk-croc" value="Pepino"><span>Pepino</span></label>
                            <label class="chip-label"><input type="checkbox" class="chk-croc" value="Beterraba"><span>Beterraba</span></label>
                            <label class="chip-label"><input type="checkbox" class="chk-croc" value="Palmito"><span>Palmito</span></label>
                            <label class="chip-label"><input type="checkbox" class="chk-croc" value="Cogumelos"><span>Cogumelos (+R$4)</span></label>
                        </div>
                    </div>
                    <div class="categoria-menu">
                        <h4>4. Folhas</h4>
                        <div class="chips-container">
                            <label class="chip-label"><input type="checkbox" class="chk-folha" value="Mix de Alface"><span>Alface</span></label>
                            <label class="chip-label"><input type="checkbox" class="chk-folha" value="R√∫cula"><span>R√∫cula</span></label>
                            <label class="chip-label"><input type="checkbox" class="chk-folha" value="Repolho"><span>Repolho</span></label>
                            <label class="chip-label"><input type="checkbox" class="chk-folha" value="Acelga"><span>Acelga</span></label>
                        </div>
                    </div>
                    <div class="categoria-menu">
                        <h4>5. Toques & Molhos</h4>
                        <div class="chips-container">
                            <label class="chip-label"><input type="checkbox" class="chk-toque" value="Linha√ßa"><span>Linha√ßa</span></label>
                            <label class="chip-label"><input type="checkbox" class="chk-toque" value="Gergelim"><span>Gergelim</span></label>
                            <label class="chip-label"><input type="checkbox" class="chk-toque" value="Chia"><span>Chia</span></label>
                            <label class="chip-label"><input type="checkbox" class="chk-toque" value="Nozes"><span>Nozes (+R$4)</span></label>
                            <label class="chip-label"><input type="checkbox" class="chk-toque" value="Castanha"><span>Castanha (+R$4)</span></label>
                            <label class="chip-label"><input type="checkbox" class="chk-molho" value="Mostarda e Mel"><span>Mostarda/Mel</span></label>
                            <label class="chip-label"><input type="checkbox" class="chk-molho" value="Ros√©"><span>Ros√©</span></label>
                            <label class="chip-label"><input type="checkbox" class="chk-molho" value="Iogurte"><span>Iogurte</span></label>
                        </div>
                    </div>
                </div>

                <div class="rodape-pdv">
                    <button class="btn-add-item" onclick="adicionarItemCesta()">üõí Adicionar Copo ao Pedido</button>
                    
                    <div id="carrinho-area" class="carrinho-area" style="display: none;">
                        <div class="carrinho-titulo">
                            <span>Itens no Pedido:</span>
                            <span id="contador-carrinho">0</span>
                        </div>
                        <div id="lista-carrinho"></div>
                    </div>

                    <div class="dados-cliente" style="margin-top: 15px;">
                        <div class="input-group">
                            <label>Pagamento</label>
                            <select id="pagamento">
                                <option value="Pendente">‚ö†Ô∏è Cobrar na Entrega</option>
                                <option value="Pago">‚úÖ J√° Pago</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Agendar Hor√°rio</label>
                            <input type="time" id="horarioEntrega">
                        </div>
                    </div>
                    
                    <div class="dados-cliente">
                        <div class="input-group" style="flex: 2;">
                            <label>Obs. do Pedido</label>
                            <input type="text" id="observacao" placeholder="Ex: Troco p/ 50..." autocomplete="off">
                        </div>
                        <div class="input-group" style="flex: 0 0 auto; display: flex; align-items: flex-end;">
                            <div class="checkbox-btn-wrapper">
                                <input type="checkbox" id="prioridade">
                                <label for="prioridade">üî• URGENTE</label>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; flex-direction: column;">
                        <button class="btn-resumo-zap" onclick="enviarResumoZap()">üí¨ Enviar Resumo p/ Confer√™ncia</button>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-cancelar" id="btn-cancelar-edicao" onclick="cancelarEdicao()">‚ùå Cancelar</button>
                            <button class="btn-finalizar" id="btn-finalizar" onclick="enviarPedidoCompleto()">‚úÖ Finalizar Pedido</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-entregas" class="view-section">
            <div class="kanban-board">
                <div class="kanban-col" id="col-novos"><h3>üî¥ Fila <span class="badge-qtd" id="qtd-novos">0</span></h3></div>
                <div class="kanban-col" id="col-preparo"><h3>üü° Montando <span class="badge-qtd" id="qtd-preparo">0</span></h3></div>
                <div class="kanban-col" id="col-rota"><h3>üîµ Rota <span class="badge-qtd" id="qtd-rota">0</span></h3></div>
                <div class="kanban-col" id="col-entregue"><h3>üü¢ Entregues <span class="badge-qtd" id="qtd-entregue">0</span></h3></div>
            </div>
        </div>

        <div id="view-financeiro" class="view-section">
            <div class="pdv-container">
                <h3 class="pdv-titulo">üí∞ Fechamento de Caixa</h3>
                <div class="card-resumo-dia">
                    <h2 id="titulo-dia-atual">HOJE (---)</h2>
                    <div class="valor-total" id="total-dia-hoje">R$ 0,00</div>
                    <div class="detalhes-dia">
                        <span id="qtd-pedidos-hoje">0 Pedidos</span>
                        <span>‚Ä¢</span>
                        <span id="qtd-itens-hoje">0 Copos</span>
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table class="tabela-historico">
                        <thead>
                            <tr><th>Data</th><th>Pedidos</th><th>Total</th></tr>
                        </thead>
                        <tbody id="tabela-historico-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-compras" class="view-section">
            <div class="pdv-container lista-compras-container">
                <h3 class="pdv-titulo">üõí Compras</h3>
                <div class="add-item-row">
                    <input type="text" id="novo-item-compra" placeholder="Ex: Comprar Morangos...">
                    <button class="btn-add-shop" onclick="adicionarItemCompra()">+</button>
                </div>
                <div id="lista-itens-compras"></div>
            </div>
        </div>

    </div>

    <nav class="bottom-nav">
        <button class="nav-item ativa" id="tab-lancamento" onclick="mudarAba('view-lancamento', 'tab-lancamento')">
            <span>üìù</span>
            <span>Novo</span>
        </button>
        <button class="nav-item" id="tab-entregas" onclick="mudarAba('view-entregas', 'tab-entregas')">
            <span>üõµ</span>
            <span>Entregas</span>
        </button>
        <button class="nav-item" id="tab-financeiro" onclick="mudarAba('view-financeiro', 'tab-financeiro')">
            <span>üí∞</span>
            <span>Caixa</span>
        </button>
        <button class="nav-item" id="tab-compras" onclick="mudarAba('view-compras', 'tab-compras')">
            <span>üõí</span>
            <span>Lista</span>
        </button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, onValue, push, set, update, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCL5banCYijxDHRGxQcDZOmnUnHaS_8Omg",
            authDomain: "isa-no-copo-pdv.firebaseapp.com",
            databaseURL: "https://isa-no-copo-pdv-default-rtdb.firebaseio.com",
            projectId: "isa-no-copo-pdv",
            storageBucket: "isa-no-copo-pdv.firebasestorage.app",
            messagingSenderId: "386835506265",
            appId: "1:386835506265:web:154cafa56da36ca14afd48"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let estadoCartoes = {}; 
        let contadorComanda = 1;
        let tipoEntregaAtual = 'entrega';
        let cestaDePedidos = [];
        let pedidoEmEdicaoId = null;
        let pedidosCache = {}; 

        // FIREBASE: Compras
        onValue(ref(db, 'compras'), (snapshot) => {
            const listaDiv = document.getElementById('lista-itens-compras');
            listaDiv.innerHTML = '';
            const itens = snapshot.val();
            if(itens) {
                Object.entries(itens).forEach(([key, item]) => {
                    const classeComprado = item.comprado ? 'comprado' : '';
                    const checkIcon = item.comprado ? '‚úîÔ∏è' : '';
                    const html = `
                        <div class="item-compra ${classeComprado}">
                            <div style="display:flex; align-items:center; flex:1;">
                                <button class="btn-check-compra" onclick="toggleCompra('${key}', ${item.comprado})">${checkIcon}</button>
                                <span>${item.nome}</span>
                            </div>
                            <button class="btn-del-compra" style="border:none; color:red; cursor:pointer;" onclick="deletarCompra('${key}')">‚úï</button>
                        </div>`;
                    listaDiv.innerHTML += html;
                });
            } else { listaDiv.innerHTML = '<p style="text-align:center; color:#999;">Lista vazia!</p>'; }
        });

        // CALCULO DE PRE√áO (Item individual)
        function calcularValorItem(item) {
            let total = 0;
            if(item.tamanho.includes('750')) total += 22.00; else total += 17.00;
            if(item.toque) {
                if(item.toque.includes('Nozes')) total += 4.00;
                if(item.toque.includes('Castanha')) total += 4.00;
            }
            if(item.croc && item.croc.includes('Cogumelos')) total += 4.00;
            return total;
        }

        function calcularValorTotalPedido(itens, tipoEntrega) {
            let total = 0;
            if(tipoEntrega === 'entrega') total += 4.00;
            if(itens && Array.isArray(itens)) {
                itens.forEach(item => total += calcularValorItem(item));
            }
            return total;
        }

        // FIREBASE: Pedidos e Financeiro
        onValue(ref(db, 'contador'), (snapshot) => { contadorComanda = snapshot.val() || 1; });

        onValue(ref(db, 'pedidos'), (snapshot) => {
            pedidosCache = snapshot.val() || {}; 
            
            // --- ATUALIZA√á√ÉO DO KANBAN ---
            let qtd = { 'col-novos': 0, 'col-preparo': 0, 'col-rota': 0, 'col-entregue': 0 };
            document.getElementById('col-novos').innerHTML = `<h3>üî¥ Fila <span class="badge-qtd" id="qtd-novos">0</span></h3>`;
            document.getElementById('col-preparo').innerHTML = `<h3>üü° Montando <span class="badge-qtd" id="qtd-preparo">0</span></h3>`;
            document.getElementById('col-rota').innerHTML = `<h3>üîµ Rota <span class="badge-qtd" id="qtd-rota">0</span></h3>`;
            document.getElementById('col-entregue').innerHTML = `<h3>üü¢ Entregues <span class="badge-qtd" id="qtd-entregue">0</span></h3>`;

            const historico = {};
            const hojeStr = new Date().toLocaleDateString('pt-BR');

            if (pedidosCache) {
                Object.entries(pedidosCache).forEach(([chaveBanco, ped]) => {
                    qtd[ped.status]++; 
                    renderizarCartao(chaveBanco, ped);

                    // FINANCEIRO
                    const dataPedido = ped.timestamp ? new Date(ped.timestamp).toLocaleDateString('pt-BR') : hojeStr;
                    if(!historico[dataPedido]) {
                        historico[dataPedido] = { total: 0, qtdPedidos: 0, qtdItens: 0 };
                    }
                    
                    // Normaliza lista de itens
                    const listaItens = (ped.itens && Array.isArray(ped.itens)) ? ped.itens : [
                        { tamanho: ped.tamanho, base: ped.base, prot: ped.prot, croc: ped.croc, folha: ped.folha, toque: ped.toque, molho: ped.molho }
                    ];

                    const valorPed = calcularValorTotalPedido(listaItens, ped.tipoEntrega);
                    const numItens = listaItens.length;

                    historico[dataPedido].total += valorPed;
                    historico[dataPedido].qtdPedidos += 1;
                    historico[dataPedido].qtdItens += numItens;
                });
            }
            Object.keys(qtd).forEach(k => document.getElementById(k.replace('col','qtd')).innerText = qtd[k]);

            // --- RENDERIZA FINANCEIRO ---
            const dadosHoje = historico[hojeStr] || { total: 0, qtdPedidos: 0, qtdItens: 0 };
            document.getElementById('titulo-dia-atual').innerText = `HOJE (${hojeStr})`;
            document.getElementById('total-dia-hoje').innerText = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(dadosHoje.total);
            document.getElementById('qtd-pedidos-hoje').innerText = `${dadosHoje.qtdPedidos} Pedidos`;
            document.getElementById('qtd-itens-hoje').innerText = `${dadosHoje.qtdItens} Copos`;

            const tabelaBody = document.getElementById('tabela-historico-body');
            tabelaBody.innerHTML = '';
            
            Object.keys(historico).sort((a,b) => {
                const da = a.split('/').reverse().join('');
                const db = b.split('/').reverse().join('');
                return db.localeCompare(da);
            }).forEach(data => {
                if(data === hojeStr) return; 
                const d = historico[data];
                const linha = `<tr><td>${data}</td><td>${d.qtdPedidos} ped <small>(${d.qtdItens} copos)</small></td><td class="valor-linha">${new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(d.total)}</td></tr>`;
                tabelaBody.innerHTML += linha;
            });
        });

        // FUN√á√ÉO RENDERIZAR CART√ÉO
        function renderizarCartao(chaveBanco, ped) {
            let linhaEndereco = '', linkMapaHTML = '', tagLocal = '';
            if (ped.tipoEntrega === 'retirada') {
                tagLocal = `<span class="retirada-tag">üèÉ RETIRADA</span>`;
                linhaEndereco = `<p style="color:var(--azul); font-weight:bold;">Cliente retira no balc√£o</p>`;
            } else {
                tagLocal = `<span class="bairro-tag">üìç ${ped.bairro}</span>`;
                linhaEndereco = `<p><strong>End:</strong> ${ped.endereco}</p>`;
                const enderecoBusca = encodeURIComponent(`${ped.endereco}, ${ped.bairro}, Tupi Paulista - SP`);
                linkMapaHTML = `<a href="https://www.google.com/maps/search/?api=1&query=${enderecoBusca}" target="_blank" class="btn-link btn-mapa">üó∫Ô∏è Maps</a>`;
            }

            let tagsExtras = '';
            let classePrioridade = '';
            if(ped.prioridade) { tagsExtras += `<span class="prioridade-tag">üî• URGENTE</span> `; classePrioridade = 'prioridade'; }
            if(ped.horarioEntrega) { tagsExtras += `<span class="horario-tag">‚è∞ ${ped.horarioEntrega}</span> `; }

            let btnWhatsHTML = '';
            if(ped.telefone && ped.telefone.length >= 14) {
                const numLimpo = ped.telefone.replace(/\D/g, '');
                let textoMsg = `Ol√° ${ped.nome}! Seu pedido est√° pronto!`;
                const linkWhats = `https://wa.me/55${numLimpo}?text=${encodeURIComponent(textoMsg)}`;
                const displayWhats = (ped.status === 'col-rota') ? 'flex' : 'none';
                btnWhatsHTML = `<a href="${linkWhats}" target="_blank" class="btn-link btn-whats" style="display: ${displayWhats};">üí¨ Avisar</a>`;
            }

            let btnMoverHTML = '', btnVoltarHTML = '', corBorda = '', minimizarPadrao = false;

            if(ped.status === 'col-novos') {
                btnMoverHTML = `<button class="btn-mover" onclick="moverPedido('${chaveBanco}', 'col-preparo')">Avan√ßar Etapa ‚ûî</button>`;
                corBorda = 'var(--laranja)';
            } else if (ped.status === 'col-preparo') {
                btnVoltarHTML = `<button class="btn-voltar" onclick="moverPedido('${chaveBanco}', 'col-novos')" title="Voltar">‚¨ÖÔ∏è</button>`;
                const textoBotao = ped.tipoEntrega === 'retirada' ? 'Pronto p/ Retirada ‚ûî' : 'Saiu p/ Entrega ‚ûî';
                btnMoverHTML = `<button class="btn-mover" onclick="moverPedido('${chaveBanco}', 'col-rota')">${textoBotao}</button>`;
                corBorda = 'var(--laranja)';
                minimizarPadrao = true;
            } else if (ped.status === 'col-rota') {
                btnVoltarHTML = `<button class="btn-voltar" onclick="moverPedido('${chaveBanco}', 'col-preparo')" title="Voltar">‚¨ÖÔ∏è</button>`;
                btnMoverHTML = `<button class="btn-mover" style="background: var(--primaria); color: white;" onclick="moverPedido('${chaveBanco}', 'col-entregue')">Finalizar ‚úîÔ∏è</button>`;
                corBorda = 'var(--azul)';
                minimizarPadrao = false; 
            } else if (ped.status === 'col-entregue') {
                btnVoltarHTML = `<button class="btn-voltar" onclick="moverPedido('${chaveBanco}', 'col-rota')" title="Voltar">‚¨ÖÔ∏è</button>`;
                corBorda = 'var(--primaria)';
                minimizarPadrao = true;
            }

            let classeMinimizado = minimizarPadrao ? 'minimizado' : '';
            if (estadoCartoes[chaveBanco] === 'aberto') classeMinimizado = '';
            if (estadoCartoes[chaveBanco] === 'fechado') classeMinimizado = 'minimizado';
            let opacidade = (ped.status === 'col-entregue') ? '0.5' : '1';

            // Normaliza lista para calculo e display
            const listaItens = (ped.itens && Array.isArray(ped.itens)) ? ped.itens : [
                { tamanho: ped.tamanho, base: ped.base, prot: ped.prot, croc: ped.croc, folha: ped.folha, toque: ped.toque, molho: ped.molho }
            ];

            const valorTotal = calcularValorTotalPedido(listaItens, ped.tipoEntrega);
            const badgePagamentoHTML = ped.pagamento === 'Pago' ? `<span class="badge-pago">‚úÖ Pago (R$ ${valorTotal})</span>` : `<span class="badge-pendente">‚ö†Ô∏è R$ ${valorTotal}</span>`;
            const obsHTML = ped.observacao ? `<div class="obs-destaque">üìå ${ped.observacao}</div>` : '';

            let itensHTML = '';
            listaItens.forEach((item, index) => {
                itensHTML += `<div class="item-resumo"><span class="titulo-item">Item ${index+1}: ${item.tamanho}</span><span>${item.base} | ${item.prot} | ${item.croc}</span><span>${item.folha} | ${item.molho} | ${item.toque}</span></div>`;
            });

            const displayAcoes = 'flex'; 

            const cardHTML = `
                <div class="pedido-card ${classeMinimizado} ${classePrioridade}" id="${chaveBanco}" style="border-left-color: ${corBorda}; opacity: ${opacidade};">
                    <div class="card-topo" onclick="toggleMinimizar('${chaveBanco}')">
                        <div style="display: flex; align-items: center;">
                            <span class="id-pedido">#${ped.numero}</span>
                            <div>
                                ${tagLocal} ${tagsExtras}
                                <h4>${ped.nome} (${listaItens.length} Itens)</h4>
                            </div>
                        </div>
                        <span class="icone-toggle">‚ñº</span>
                    </div>
                    
                    <div class="card-detalhes">
                        <div class="badges-pagamento">${badgePagamentoHTML}</div>
                        ${ped.telefone ? `<p><strong>Tel:</strong> ${ped.telefone}</p>` : ''}
                        ${obsHTML}
                        <div class="lista-montagem">${itensHTML}</div>
                        ${linhaEndereco}
                        <div class="grid-botoes-contato">${linkMapaHTML}${btnWhatsHTML}</div>
                    </div>

                    <div class="acoes-card" style="display: ${displayAcoes}">
                        ${btnVoltarHTML}
                        ${btnMoverHTML}
                        <button class="btn-editar" onclick="editarPedido('${chaveBanco}')" title="Editar">‚úèÔ∏è</button>
                        <button class="btn-remover" onclick="removerPedido('${chaveBanco}')">üóëÔ∏è</button>
                    </div>
                    ${ped.status === 'col-entregue' ? `<button class="btn-remover" style="margin-top:10px; width: 100%;" onclick="removerPedido('${chaveBanco}')">üóëÔ∏è Limpar do Quadro</button>` : ''}
                </div>
            `;
            document.getElementById(ped.status).innerHTML += cardHTML;
        }

        // --- FUN√á√ïES DE CARRINHO ---
        window.adicionarItemCesta = function() {
            const tamanho = document.getElementById('tamanho').value;
            const pegar = (cls) => { const m = Array.from(document.querySelectorAll('.'+cls+':checked')); return m.length===0?'Nenhum':m.map(c=>c.value).join(', '); };
            
            const item = {
                tamanho: tamanho,
                base: pegar('chk-base'), prot: pegar('chk-prot'), croc: pegar('chk-croc'),
                folha: pegar('chk-folha'), toque: pegar('chk-toque'), molho: pegar('chk-molho')
            };

            cestaDePedidos.push(item);
            atualizarVisualCarrinho();
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => { if(!cb.id.includes('prioridade')) cb.checked = false; });
            document.getElementById('tamanho').value = 'Copo 550ml';
            
            const btn = document.querySelector('.btn-add-item');
            const txt = btn.innerHTML;
            btn.innerHTML = "Item Adicionado!";
            setTimeout(() => btn.innerHTML = txt, 1000);
        };

        function atualizarVisualCarrinho() {
            const area = document.getElementById('carrinho-area');
            const lista = document.getElementById('lista-carrinho');
            const btn = document.getElementById('btn-finalizar');
            const contador = document.getElementById('contador-carrinho');
            
            lista.innerHTML = '';
            contador.innerText = cestaDePedidos.length;

            if(cestaDePedidos.length > 0) {
                area.style.display = 'block';
                btn.classList.add('ativo');
                
                if(pedidoEmEdicaoId) {
                     btn.innerHTML = `üíæ Salvar Altera√ß√µes (${cestaDePedidos.length} Itens)`;
                     btn.classList.add('btn-salvar-edicao');
                } else {
                     btn.innerHTML = `‚úÖ Finalizar Pedido (${cestaDePedidos.length} Itens)`;
                     btn.classList.remove('btn-salvar-edicao');
                }
                
                cestaDePedidos.forEach((item, idx) => {
                    const valorItem = calcularValorItem(item);
                    lista.innerHTML += `
                        <div class="item-carrinho">
                            <span><strong>${idx+1}.</strong> ${item.tamanho} (R$ ${valorItem})</span>
                            <button class="btn-rm-item" onclick="removerItemCesta(${idx})">‚úï</button>
                        </div>
                    `;
                });
            } else {
                area.style.display = 'none';
                btn.classList.remove('ativo');
            }
        }

        window.removerItemCesta = function(index) {
            cestaDePedidos.splice(index, 1);
            atualizarVisualCarrinho();
        };

        // --- ENVIAR RESUMO WHATSAPP ---
        window.enviarResumoZap = function() {
            const nome = document.getElementById('nome').value;
            const telefone = document.getElementById('telefone').value;
            const bairro = document.getElementById('bairro').value;
            const endereco = document.getElementById('endereco').value;
            const pagamento = document.getElementById('pagamento').value;
            const obs = document.getElementById('observacao').value;

            if(!nome) return alert("Preencha o nome do cliente!");
            if(cestaDePedidos.length === 0) return alert("Adicione itens ao carrinho primeiro!");
            if(!telefone || telefone.length < 14) return alert("Preencha o WhatsApp do cliente para enviar!");

            let msg = `*üßæ CONFER√äNCIA - √çSA NO COPO*\n`;
            msg += `------------------------------\n`;
            msg += `*Cliente:* ${nome}\n\n`;
            
            cestaDePedidos.forEach((item, idx) => {
                msg += `*Item ${idx+1}:* ${item.tamanho}\n`;
                msg += `Base: ${item.base}\n`;
                msg += `Prot: ${item.prot}\n`;
                msg += `Croc: ${item.croc}\n`;
                msg += `Folhas: ${item.folha}\n`;
                msg += `Toque: ${item.toque}\n`;
                msg += `Molho: ${item.molho}\n`;
                msg += `------------------------------\n`;
            });

            const total = calcularValorTotalPedido(cestaDePedidos, tipoEntregaAtual);
            
            msg += `*Tipo:* ${tipoEntregaAtual === 'entrega' ? 'üõµ Entrega' : 'üèÉ Retirada'}\n`;
            if(tipoEntregaAtual === 'entrega') msg += `*End:* ${endereco}, ${bairro}\n`;
            if(obs) msg += `*Obs:* ${obs}\n`;
            msg += `*Pagamento:* ${pagamento}\n\n`;
            msg += `*TOTAL A PAGAR: R$ ${total},00*\n\n`;
            msg += `Confere se est√° tudo certinho?`;

            const numLimpo = telefone.replace(/\D/g, '');
            window.open(`https://wa.me/55${numLimpo}?text=${encodeURIComponent(msg)}`, '_blank');
        };

        // --- FUN√á√ÉO PRINCIPAL: ENVIAR/ATUALIZAR ---
        window.enviarPedidoCompleto = function() {
            const nome = document.getElementById('nome').value;
            const telefone = document.getElementById('telefone').value;
            const bairro = document.getElementById('bairro').value;
            const endereco = document.getElementById('endereco').value;
            const pagamento = document.getElementById('pagamento').value;
            const observacao = document.getElementById('observacao').value;
            const prioridade = document.getElementById('prioridade').checked;
            const horarioEntrega = document.getElementById('horarioEntrega').value;

            if(!nome) { alert("Nome obrigat√≥rio!"); return; }
            if(tipoEntregaAtual === 'entrega' && (!bairro || !endereco)) { alert("Endere√ßo obrigat√≥rio!"); return; }
            if(cestaDePedidos.length === 0) { alert("Adicione pelo menos um copo!"); return; }

            const dadosPedido = {
                nome, telefone, bairro, endereco, pagamento, observacao, prioridade, horarioEntrega,
                tipoEntrega: tipoEntregaAtual,
                itens: cestaDePedidos,
                status: 'col-novos', 
                timestamp: Date.now()
            };

            if (pedidoEmEdicaoId) {
                dadosPedido.numero = pedidosCache[pedidoEmEdicaoId].numero;
                dadosPedido.status = pedidosCache[pedidoEmEdicaoId].status; 
                update(ref(db, 'pedidos/' + pedidoEmEdicaoId), dadosPedido);
                alert("Pedido atualizado com sucesso!");
                cancelarEdicao(); 
            } else {
                dadosPedido.numero = contadorComanda;
                push(ref(db, 'pedidos'), dadosPedido);
                set(ref(db, 'contador'), contadorComanda + 1);
                limparFormularioCompleto();
            }
        };

        // --- L√ìGICA DE EDI√á√ÉO ---
        window.editarPedido = function(id) {
            const ped = pedidosCache[id];
            if(!ped) return;

            pedidoEmEdicaoId = id; 

            document.getElementById('nome').value = ped.nome;
            document.getElementById('telefone').value = ped.telefone || '';
            document.getElementById('observacao').value = ped.observacao || '';
            document.getElementById('pagamento').value = ped.pagamento || 'Pendente';
            document.getElementById('prioridade').checked = ped.prioridade || false;
            document.getElementById('horarioEntrega').value = ped.horarioEntrega || '';
            
            setTipoEntrega(ped.tipoEntrega || 'entrega');
            if(ped.tipoEntrega !== 'retirada') {
                document.getElementById('bairro').value = ped.bairro;
                document.getElementById('endereco').value = ped.endereco;
            }

            if(ped.itens && Array.isArray(ped.itens)) {
                cestaDePedidos = [...ped.itens]; 
            } else {
                cestaDePedidos = [{
                    tamanho: ped.tamanho, base: ped.base, prot: ped.prot, croc: ped.croc,
                    folha: ped.folha, toque: ped.toque, molho: ped.molho
                }];
            }
            atualizarVisualCarrinho();

            document.getElementById('aviso-edicao').classList.add('ativo');
            document.getElementById('btn-cancelar-edicao').style.display = 'block';
            window.mudarAba('view-lancamento', 'tab-lancamento'); 
            window.scrollTo(0,0);
        };

        window.cancelarEdicao = function() {
            pedidoEmEdicaoId = null;
            document.getElementById('aviso-edicao').classList.remove('ativo');
            document.getElementById('btn-cancelar-edicao').style.display = 'none';
            limparFormularioCompleto();
            atualizarVisualCarrinho(); 
        };

        function limparFormularioCompleto() {
            document.getElementById('nome').value = ''; 
            document.getElementById('telefone').value = '';
            document.getElementById('observacao').value = '';
            document.getElementById('prioridade').checked = false;
            document.getElementById('horarioEntrega').value = '';

            if(tipoEntregaAtual === 'entrega') { document.getElementById('bairro').value = ''; document.getElementById('endereco').value = ''; }
            cestaDePedidos = [];
            atualizarVisualCarrinho();
        }

        // --- FUN√á√ïES GERAIS ---
        window.adicionarItemCompra = function() {
            const input = document.getElementById('novo-item-compra');
            if(!input.value) return;
            push(ref(db, 'compras'), { nome: input.value, comprado: false });
            input.value = ''; input.focus();
        };
        window.toggleCompra = (k, v) => update(ref(db, 'compras/' + k), { comprado: !v });
        window.deletarCompra = (k) => remove(ref(db, 'compras/' + k));

        window.setTipoEntrega = function(tipo) {
            tipoEntregaAtual = tipo;
            const camposEnd = document.querySelectorAll('.grupo-endereco');
            if(tipo === 'retirada') {
                document.getElementById('btn-retirada').classList.add('ativo');
                document.getElementById('btn-entrega').classList.remove('ativo');
                camposEnd.forEach(el => el.style.display = 'none');
                document.getElementById('bairro').value = 'Balc√£o'; document.getElementById('endereco').value = 'Retirada'; 
            } else {
                document.getElementById('btn-entrega').classList.add('ativo');
                document.getElementById('btn-retirada').classList.remove('ativo');
                camposEnd.forEach(el => el.style.display = 'flex');
                if(!pedidoEmEdicaoId) { 
                    document.getElementById('bairro').value = ''; document.getElementById('endereco').value = '';
                }
            }
        };

        window.moverPedido = (id, s) => { update(ref(db, 'pedidos/'+id), {status:s}); if(s==='col-rota') delete estadoCartoes[id]; };
        window.removerPedido = (id) => { if(confirm("Excluir este pedido?")) remove(ref(db, 'pedidos/'+id)); };
        
        window.zerarPainel = () => { 
            const senha = prompt("üîí Digite a senha para FINALIZAR O DIA (Apaga todos os pedidos):");
            if(senha === '140520') {
                set(ref(db, 'pedidos'), null); 
                set(ref(db, 'contador'), 1);
                alert("Dia finalizado com sucesso!");
            } else if (senha !== null) {
                alert("‚õî Senha incorreta!");
            }
        };

        window.toggleMinimizar = (id) => { 
            const el = document.getElementById(id); el.classList.toggle('minimizado'); 
            estadoCartoes[id] = el.classList.contains('minimizado') ? 'fechado' : 'aberto'; 
        };
        window.mudarAba = (v, t) => {
            document.querySelectorAll('.view-section').forEach(e => e.classList.remove('ativa'));
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('ativa'));
            document.getElementById(v).classList.add('ativa'); document.getElementById(t).classList.add('ativa');
        };

        document.getElementById('telefone').addEventListener('input', function (e) {
            let x = e.target.value.replace(/\D/g, '').match(/(\d{0,2})(\d{0,5})(\d{0,4})/);
            e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
        });
        document.querySelectorAll('.chk-base').forEach(cb => {
            cb.addEventListener('change', function() { if(document.querySelectorAll('.chk-base:checked').length > 2) { this.checked = false; alert("M√°x 2 bases!"); } });
        });
        window.toggleTema = () => {
            const b = document.body;
            if(b.getAttribute('data-theme')==='dark') { b.removeAttribute('data-theme'); localStorage.setItem('isaTema', 'light'); }
            else { b.setAttribute('data-theme', 'dark'); localStorage.setItem('isaTema', 'dark'); }
        };
        if(localStorage.getItem('isaTema') === 'dark') document.body.setAttribute('data-theme', 'dark');

    </script>
</body>
</html>
