<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV √çsa no Copo - Entregas e Montagem</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        :root {
            --primaria: #10b981;
            --primaria-hover: #059669;
            --fundo-body: #f3f4f6;
            --fundo-card: #ffffff;
            --fundo-coluna: #f8fafc;
            --texto-principal: #1f2937;
            --texto-secundario: #4b5563;
            --borda: #e5e7eb;
            --borda-foco: #a7f3d0;
            --fundo-input: #f9fafb;
            --laranja: #f59e0b;
            --vermelho: #ef4444;
            --vermelho-fundo: #fef2f2;
            --azul: #3b82f6;
            --verde-whats: #25D366;
            --tag-bairro-bg: #fef3c7;
            --tag-bairro-text: #b45309;
            --lista-bg: #ecfdf5;
            --lista-text: #047857;
            --sombra: 0 4px 6px -1px rgba(0,0,0,0.05);
            --altura-nav: 70px;
        }

        [data-theme="dark"] {
            --fundo-body: #0f172a;
            --fundo-card: #1e293b;
            --fundo-coluna: #0f172a;
            --texto-principal: #f8fafc;
            --texto-secundario: #94a3b8;
            --borda: #334155;
            --borda-foco: #059669;
            --fundo-input: #0f172a;
            --vermelho-fundo: #450a0a;
            --tag-bairro-bg: #78350f;
            --tag-bairro-text: #fde68a;
            --lista-bg: #064e3b;
            --lista-text: #6ee7b7;
            --sombra: 0 4px 6px -1px rgba(0,0,0,0.3);
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--fundo-body); color: var(--texto-principal); margin: 0; padding: 0; padding-bottom: var(--altura-nav); transition: 0.3s; }

        /* Cabe√ßalho Fixo */
        header { background: var(--fundo-card); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--borda); position: sticky; top: 0; z-index: 100; }
        header h1 { margin: 0; font-size: 18px; color: var(--primaria); display: flex; align-items: center; gap: 8px; }
        .controles-header { display: flex; gap: 8px; align-items: center; }
        
        .status-nuvem { font-size: 11px; font-weight: bold; color: var(--primaria); display: flex; align-items: center; gap: 5px; background: var(--lista-bg); padding: 6px 10px; border-radius: 20px;}
        .status-nuvem span { display: inline-block; width: 8px; height: 8px; background: var(--primaria); border-radius: 50%; animation: piscar 2s infinite; }
        @keyframes piscar { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        .btn-acao { background: var(--fundo-card); color: var(--texto-principal); border: 1px solid var(--borda); padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; transition: 0.2s; }
        .btn-acao:hover { background: var(--fundo-body); }
        .btn-limpar { color: var(--vermelho); border-color: var(--vermelho); }
        .btn-limpar:hover { background: var(--vermelho-fundo); }

        /* Estrutura Principal (Grid para PC, Abas para Celular) */
        .container-master { padding: 20px; max-width: 1600px; margin: auto; display: flex; flex-direction: column; gap: 20px; }
        
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.ativa { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Formul√°rio PDV */
        .pdv-container { background: var(--fundo-card); padding: 20px; border-radius: 12px; box-shadow: var(--sombra); border: 1px solid var(--borda); }
        .pdv-titulo { font-size: 15px; color: var(--texto-principal); margin-top: 0; border-bottom: 1px solid var(--borda); padding-bottom: 10px; margin-bottom: 20px; text-transform: uppercase; font-weight: 700; }
        
        .dados-cliente { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 25px; }
        .input-group { display: flex; flex-direction: column; flex: 1; min-width: 160px; }
        .input-group label { font-size: 13px; font-weight: 600; color: var(--texto-secundario); margin-bottom: 6px; }
        .dados-cliente input, .dados-cliente select { padding: 14px 15px; border: 1px solid var(--borda); border-radius: 8px; font-size: 15px; background-color: var(--fundo-input); color: var(--texto-principal); transition: 0.2s; }
        .dados-cliente input:focus, .dados-cliente select:focus { outline: none; border-color: var(--primaria); box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1); }

        .cardapio-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .categoria-menu { background: var(--fundo-body); border: 1px solid var(--borda); border-radius: 10px; padding: 15px; }
        .categoria-menu h4 { margin: 0 0 12px 0; font-size: 13px; color: var(--texto-secundario); font-weight: 700; text-transform: uppercase; }
        
        .chips-container { display: flex; flex-wrap: wrap; gap: 10px; }
        .chip-label { position: relative; display: inline-block; cursor: pointer; user-select: none; }
        .chip-label input { display: none; } 
        .chip-label span { display: inline-block; padding: 12px 14px; border-radius: 20px; border: 1px solid var(--borda); font-size: 14px; background: var(--fundo-card); color: var(--texto-secundario); font-weight: 500; transition: 0.2s; }
        .chip-label input:checked + span { background: var(--primaria); color: white; border-color: var(--primaria); box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3); }

        .rodape-pdv { display: flex; justify-content: flex-end; border-top: 1px solid var(--borda); padding-top: 20px; }
        .btn-add { background: var(--primaria); color: white; border: none; padding: 16px 30px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 16px; width: 100%; transition: 0.2s; box-shadow: 0 4px 6px rgba(16, 185, 129, 0.2); }
        .btn-add:hover { background: var(--primaria-hover); transform: translateY(-2px); }

        /* Kanban Board */
        .kanban-board { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 20px; min-height: 60vh; scroll-snap-type: x mandatory; }
        .kanban-col { background: var(--fundo-coluna); border-radius: 12px; width: 85vw; max-width: 340px; min-width: 300px; padding: 15px; display: flex; flex-direction: column; gap: 15px; border: 1px solid var(--borda); scroll-snap-align: center; }
        .kanban-col h3 { margin: 0 0 10px 0; font-size: 14px; font-weight: 700; padding-bottom: 10px; border-bottom: 2px solid var(--borda); text-transform: uppercase; color: var(--texto-principal); display: flex; justify-content: space-between; align-items: center; }
        .badge-qtd { background: var(--borda); color: var(--texto-secundario); padding: 2px 8px; border-radius: 12px; font-size: 12px; }

        /* Cart√µes */
        .pedido-card { background: var(--fundo-card); padding: 15px; border-radius: 10px; box-shadow: var(--sombra); border: 1px solid var(--borda); border-left: 5px solid var(--laranja); transition: 0.3s; display: flex; flex-direction: column; gap: 10px; }
        
        .card-topo { cursor: pointer; display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 5px; }
        .id-pedido { font-size: 18px; font-weight: 900; color: var(--texto-secundario); margin-right: 8px; }
        .bairro-tag { display: inline-block; background: var(--tag-bairro-bg); color: var(--tag-bairro-text); padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; margin-bottom: 6px; text-transform: uppercase; }
        .card-topo h4 { margin: 0; font-size: 16px; font-weight: 700; color: var(--texto-principal); }
        .icone-toggle { color: var(--texto-secundario); font-size: 12px; transition: 0.3s; padding-top: 5px; }

        .card-detalhes { overflow: hidden; transition: max-height 0.3s ease; }
        .pedido-card.minimizado .card-detalhes { display: none; }
        .pedido-card.minimizado .icone-toggle { transform: rotate(-90deg); }

        .card-detalhes p { margin: 4px 0; font-size: 13px; color: var(--texto-secundario); line-height: 1.4; }
        .card-detalhes p strong { color: var(--texto-principal); }
        
        .lista-montagem { background: var(--lista-bg); padding: 12px; border-radius: 8px; margin: 10px 0; font-size: 13px; line-height: 1.6; color: var(--lista-text); border: 1px solid var(--borda-foco); }
        .lista-montagem span { display: block; border-bottom: 1px dashed rgba(16, 185, 129, 0.3); padding-bottom: 4px; margin-bottom: 4px; }
        .lista-montagem span:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }

        .grid-botoes-contato { display: flex; gap: 8px; margin-top: 10px; }
        .btn-link { flex: 1; display: flex; justify-content: center; align-items: center; gap: 5px; text-decoration: none; padding: 10px; border-radius: 8px; font-size: 13px; font-weight: 600; transition: 0.2s; border: 1px solid transparent; }
        .btn-mapa { background: rgba(59, 130, 246, 0.1); color: var(--azul); border-color: rgba(59, 130, 246, 0.2); }
        .btn-whats { background: rgba(37, 211, 102, 0.1); color: var(--verde-whats); border-color: rgba(37, 211, 102, 0.2); }

        .acoes-card { display: flex; gap: 8px; padding-top: 5px; margin-top: 5px; border-top: 1px solid var(--borda); }
        .btn-mover { background: transparent; border: 1px solid var(--primaria); color: var(--primaria); padding: 12px; border-radius: 8px; cursor: pointer; flex: 1; font-size: 14px; font-weight: 600; transition: 0.2s; }
        .btn-mover:hover { background: var(--primaria); color: white; }
        .btn-remover { background: transparent; border: 1px solid var(--borda); color: var(--texto-secundario); padding: 12px; border-radius: 8px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center;}

        /* Menu Inferior (Bottom Navigation) Mobile */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--fundo-card); border-top: 1px solid var(--borda); display: flex; justify-content: space-around; padding: 8px 10px; z-index: 1000; box-shadow: 0 -4px 10px rgba(0,0,0,0.05); transition: 0.3s;}
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; background: transparent; border: none; padding: 8px; border-radius: 10px; color: var(--texto-secundario); cursor: pointer; transition: 0.2s; }
        .nav-item span:first-child { font-size: 20px; }
        .nav-item span:last-child { font-size: 12px; font-weight: 600; }
        .nav-item.ativo { color: var(--primaria); background: var(--lista-bg); }

        /* Ajustes Inteligentes para PC/Desktop */
        @media (min-width: 1024px) {
            body { padding-bottom: 0; }
            .bottom-nav { display: none; } /* Esconde o menu inferior no PC */
            .container-master { flex-direction: row; align-items: flex-start; }
            .view-section { display: block !important; } /* For√ßa as duas telas a aparecerem juntas */
            #view-lancamento { flex: 0 0 400px; position: sticky; top: 90px; height: calc(100vh - 120px); overflow-y: auto; }
            #view-entregas { flex: 1; overflow-hidden; }
            .btn-add { width: auto; }
            .kanban-col { min-width: 320px; }
        }
        
        /* Oculta scrollbar da √°rea de lan√ßamento no PC pra ficar elegante */
        #view-lancamento::-webkit-scrollbar { width: 6px; }
        #view-lancamento::-webkit-scrollbar-thumb { background: var(--borda); border-radius: 10px; }
    </style>
</head>
<body>

    <header>
        <h1>ü•ó √çsa no Copo</h1>
        <div class="controles-header">
            <div class="status-nuvem"><span></span> Online</div>
            <button class="btn-acao" onclick="toggleTema()" id="btn-tema">üåô</button>
            <button class="btn-acao btn-limpar" onclick="zerarPainel()">üóëÔ∏è Finalizar Dia</button>
        </div>
    </header>

    <div class="container-master">
        
        <div id="view-lancamento" class="view-section ativa">
            <div class="pdv-container">
                <h3 class="pdv-titulo">üìã Ficha do Cliente</h3>
                <div class="dados-cliente">
                    <div class="input-group">
                        <label>Nome do Cliente</label>
                        <input type="text" id="nome" placeholder="Ex: Jo√£o" autocomplete="off">
                    </div>
                    <div class="input-group">
                        <label>WhatsApp</label>
                        <input type="tel" id="telefone" placeholder="(00) 00000-0000" maxlength="15">
                    </div>
                    <div class="input-group">
                        <label>Bairro</label>
                        <input type="text" id="bairro" placeholder="Ex: Centro" autocomplete="off">
                    </div>
                    <div class="input-group" style="flex: 2;">
                        <label>Endere√ßo e N√∫mero</label>
                        <input type="text" id="endereco" placeholder="Rua das Flores, 123" autocomplete="off">
                    </div>
                    <div class="input-group">
                        <label>Tamanho</label>
                        <select id="tamanho">
                            <option value="Copo 550ml">Copo 550ml</option>
                            <option value="Copo 750ml">Copo 750ml</option>
                        </select>
                    </div>
                </div>

                <h3 class="pdv-titulo">ü•ó Montagem</h3>
                <div class="cardapio-grid">
                    <div class="categoria-menu">
                        <h4>1. Base (M√°x 2)</h4>
                        <div class="chips-container">
                            <label class="chip-label"><input type="checkbox" class="chk-base" value="Macarr√£o Gelado"><span>Macarr√£o (Fusilli)</span></label>
                            <label class="chip-label"><input type="checkbox" class="chk-base" value="Quinoa Real"><span>Quinoa Real</span></label>
                            <label class="chip-label"><input type="checkbox" class="chk-base" value="Milho Doce"><span>Milho Doce</span></label>
                            <label class="chip-label"><input type="checkbox" class="chk-base" value="Ervilhas"><span>Ervilhas</span></label>
                        </div>
                    </div>
                    <div class="categoria-menu">
                        <h4>2. Prote√≠na</h4>
                        <div class="chips-container">
                            <label class="chip-label"><input type="checkbox" class="chk-prot" value="Frango Desfiado"><span>Frango Desfiado</span></label>
                            <label class="chip-label"><input type="checkbox" class="chk-prot" value="Atum"><span>Atum</span></label>
                        </div>
                    </div>
                    <div class="categoria-menu">
                        <h4>3. Croc√¢ncia & Cor</h4>
                        <div class="chips-container">
                            <label class="chip-label"><input type="checkbox" class="chk-croc" value="Tomate Cereja"><span>Tomate Cereja</span></label>
                            <label class="chip-label"><input type="checkbox" class="chk-croc" value="Cenoura Ralada"><span>Cenoura Ralada</span></label>
                            <label class="chip-label"><input type="checkbox" class="chk-croc" value="Pepino"><span>Pepino</span></label>
                            <label class="chip-label"><input type="checkbox" class="chk-croc" value="Beterraba"><span>Beterraba</span></label>
                            <label class="chip-label"><input type="checkbox" class="chk-croc" value="Palmito"><span>Palmito</span></label>
                            <label class="chip-label"><input type="checkbox" class="chk-croc" value="Cogumelos"><span>Cogumelos</span></label>
                        </div>
                    </div>
                    <div class="categoria-menu">
                        <h4>4. Folhas Frescas</h4>
                        <div class="chips-container">
                            <label class="chip-label"><input type="checkbox" class="chk-folha" value="Mix de Alface"><span>Mix de Alface</span></label>
                            <label class="chip-label"><input type="checkbox" class="chk-folha" value="R√∫cula"><span>R√∫cula</span></label>
                            <label class="chip-label"><input type="checkbox" class="chk-folha" value="Repolho"><span>Repolho Colorido</span></label>
                            <label class="chip-label"><input type="checkbox" class="chk-folha" value="Acelga"><span>Acelga</span></label>
                        </div>
                    </div>
                    <div class="categoria-menu">
                        <h4>5. Toque Final</h4>
                        <div class="chips-container">
                            <label class="chip-label"><input type="checkbox" class="chk-toque" value="Linha√ßa"><span>Linha√ßa</span></label>
                            <label class="chip-label"><input type="checkbox" class="chk-toque" value="Gergelim"><span>Gergelim</span></label>
                            <label class="chip-label"><input type="checkbox" class="chk-toque" value="Chia"><span>Chia</span></label>
                            <label class="chip-label"><input type="checkbox" class="chk-toque" value="Nozes"><span>Nozes</span></label>
                            <label class="chip-label"><input type="checkbox" class="chk-toque" value="Castanha"><span>Castanha</span></label>
                        </div>
                    </div>
                    <div class="categoria-menu">
                        <h4>6. Molhos Artesanais</h4>
                        <div class="chips-container">
                            <label class="chip-label"><input type="checkbox" class="chk-molho" value="Mostarda e Mel"><span>Mostarda e Mel</span></label>
                            <label class="chip-label"><input type="checkbox" class="chk-molho" value="Ros√©"><span>Ros√© Cl√°ssico</span></label>
                            <label class="chip-label"><input type="checkbox" class="chk-molho" value="Iogurte c/ Ervas"><span>Iogurte c/ Ervas</span></label>
                        </div>
                    </div>
                </div>

                <div class="rodape-pdv">
                    <button class="btn-add" onclick="adicionarPedido()">‚ûï Enviar Pedido</button>
                </div>
            </div>
        </div>

        <div id="view-entregas" class="view-section">
            <div class="kanban-board">
                <div class="kanban-col" id="col-novos"><h3>üî¥ Fila <span class="badge-qtd" id="qtd-novos">0</span></h3></div>
                <div class="kanban-col" id="col-preparo"><h3>üü° Montando <span class="badge-qtd" id="qtd-preparo">0</span></h3></div>
                <div class="kanban-col" id="col-rota"><h3>üîµ Rota <span class="badge-qtd" id="qtd-rota">0</span></h3></div>
                <div class="kanban-col" id="col-entregue"><h3>üü¢ Entregues <span class="badge-qtd" id="qtd-entregue">0</span></h3></div>
            </div>
        </div>

    </div>

    <nav class="bottom-nav">
        <button class="nav-item ativa" id="tab-lancamento" onclick="mudarAba('view-lancamento', 'tab-lancamento')">
            <span>üìù</span>
            <span>Novo Pedido</span>
        </button>
        <button class="nav-item" id="tab-entregas" onclick="mudarAba('view-entregas', 'tab-entregas')">
            <span>üõµ</span>
            <span>Entregas</span>
        </button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, onValue, push, set, update, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCL5banCYijxDHRGxQcDZOmnUnHaS_8Omg",
            authDomain: "isa-no-copo-pdv.firebaseapp.com",
            databaseURL: "https://isa-no-copo-pdv-default-rtdb.firebaseio.com",
            projectId: "isa-no-copo-pdv",
            storageBucket: "isa-no-copo-pdv.firebasestorage.app",
            messagingSenderId: "386835506265",
            appId: "1:386835506265:web:154cafa56da36ca14afd48"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let estadoCartoes = {}; 
        let contadorComanda = 1;

        onValue(ref(db, 'contador'), (snapshot) => { contadorComanda = snapshot.val() || 1; });

        onValue(ref(db, 'pedidos'), (snapshot) => {
            // Zera as colunas e as contagens
            let qtd = { 'col-novos': 0, 'col-preparo': 0, 'col-rota': 0, 'col-entregue': 0 };
            
            document.getElementById('col-novos').innerHTML = `<h3>üî¥ Fila <span class="badge-qtd" id="qtd-novos">0</span></h3>`;
            document.getElementById('col-preparo').innerHTML = `<h3>üü° Montando <span class="badge-qtd" id="qtd-preparo">0</span></h3>`;
            document.getElementById('col-rota').innerHTML = `<h3>üîµ Rota <span class="badge-qtd" id="qtd-rota">0</span></h3>`;
            document.getElementById('col-entregue').innerHTML = `<h3>üü¢ Entregues <span class="badge-qtd" id="qtd-entregue">0</span></h3>`;

            const pedidos = snapshot.val();
            if (!pedidos) return;

            Object.entries(pedidos).forEach(([chaveBanco, ped]) => {
                qtd[ped.status]++; // Aumenta a contagem daquela coluna

                const enderecoBusca = encodeURIComponent(`${ped.endereco}, ${ped.bairro}, Tupi Paulista - SP`);
                const linkMapa = `https://www.google.com/maps/search/?api=1&query=${enderecoBusca}`;

                let btnWhatsHTML = '';
                if(ped.telefone && ped.telefone.length >= 14) {
                    const numLimpo = ped.telefone.replace(/\D/g, '');
                    const msgWhats = encodeURIComponent(`Ol√° ${ped.nome}! Seu pedido da √çsa no Copo acabou de sair para entrega e est√° a caminho! ü•óüõµ`);
                    const linkWhats = `https://wa.me/55${numLimpo}?text=${msgWhats}`;
                    const displayWhats = (ped.status === 'col-rota') ? 'flex' : 'none';
                    btnWhatsHTML = `<a href="${linkWhats}" target="_blank" class="btn-link btn-whats" style="display: ${displayWhats};">üí¨ Avisar Sa√≠da</a>`;
                }

                let btnMoverHTML = '';
                let corBorda = '';
                let minimizarPadrao = false;

                if(ped.status === 'col-novos') {
                    btnMoverHTML = `<button class="btn-mover" onclick="moverPedido('${chaveBanco}', 'col-preparo')">Avan√ßar Etapa ‚ûî</button>`;
                    corBorda = 'var(--laranja)';
                } else if (ped.status === 'col-preparo') {
                    btnMoverHTML = `<button class="btn-mover" onclick="moverPedido('${chaveBanco}', 'col-rota')">Saiu p/ Entrega ‚ûî</button>`;
                    corBorda = 'var(--laranja)';
                    minimizarPadrao = true;
                } else if (ped.status === 'col-rota') {
                    btnMoverHTML = `<button class="btn-mover" style="background: var(--primaria); color: white;" onclick="moverPedido('${chaveBanco}', 'col-entregue')">Finalizar ‚úîÔ∏è</button>`;
                    corBorda = 'var(--azul)';
                    minimizarPadrao = false; 
                } else if (ped.status === 'col-entregue') {
                    corBorda = 'var(--primaria)';
                    minimizarPadrao = true;
                }

                let classeMinimizado = minimizarPadrao ? 'minimizado' : '';
                if (estadoCartoes[chaveBanco] === 'aberto') classeMinimizado = '';
                if (estadoCartoes[chaveBanco] === 'fechado') classeMinimizado = 'minimizado';
                let opacidade = (ped.status === 'col-entregue') ? '0.5' : '1';

                const cardHTML = `
                    <div class="pedido-card ${classeMinimizado}" id="${chaveBanco}" style="border-left-color: ${corBorda}; opacity: ${opacidade};">
                        <div class="card-topo" onclick="toggleMinimizar('${chaveBanco}')">
                            <div style="display: flex; align-items: center;">
                                <span class="id-pedido">#${ped.numero}</span>
                                <div>
                                    <span class="bairro-tag">üìç ${ped.bairro}</span>
                                    <h4>${ped.nome}</h4>
                                </div>
                            </div>
                            <span class="icone-toggle">‚ñº</span>
                        </div>
                        
                        <div class="card-detalhes">
                            <p><strong>Tamanho:</strong> ${ped.tamanho}</p>
                            ${ped.telefone ? `<p><strong>WhatsApp:</strong> ${ped.telefone}</p>` : ''}
                            
                            <div class="lista-montagem">
                                <span><strong>1. Base:</strong> ${ped.base}</span>
                                <span><strong>2. Prote√≠na:</strong> ${ped.prot}</span>
                                <span><strong>3. Croc√¢ncia:</strong> ${ped.croc}</span>
                                <span><strong>4. Folhas:</strong> ${ped.folha}</span>
                                <span><strong>5. Toques:</strong> ${ped.toque}</span>
                                <span><strong>Molhos:</strong> ${ped.molho}</span>
                            </div>

                            <p><strong>End:</strong> ${ped.endereco}</p>
                            
                            <div class="grid-botoes-contato">
                                <a href="${linkMapa}" target="_blank" class="btn-link btn-mapa">üó∫Ô∏è Maps</a>
                                ${btnWhatsHTML}
                            </div>
                        </div>

                        <div class="acoes-card" style="display: ${ped.status === 'col-entregue' ? 'none' : 'flex'}">
                            ${btnMoverHTML}
                            <button class="btn-remover" onclick="removerPedido('${chaveBanco}')">üóëÔ∏è</button>
                        </div>
                        ${ped.status === 'col-entregue' ? `<button class="btn-remover" style="margin-top:10px; width: 100%;" onclick="removerPedido('${chaveBanco}')">üóëÔ∏è Limpar Entregue</button>` : ''}
                    </div>
                `;

                document.getElementById(ped.status).innerHTML += cardHTML;
            });

            // Atualiza os emblemas (badges) com as quantidades
            document.getElementById('qtd-novos').innerText = qtd['col-novos'];
            document.getElementById('qtd-preparo').innerText = qtd['col-preparo'];
            document.getElementById('qtd-rota').innerText = qtd['col-rota'];
            document.getElementById('qtd-entregue').innerText = qtd['col-entregue'];
        });

        window.adicionarPedido = function() {
            const nome = document.getElementById('nome').value;
            const telefone = document.getElementById('telefone').value;
            const bairro = document.getElementById('bairro').value;
            const endereco = document.getElementById('endereco').value;
            const tamanho = document.getElementById('tamanho').value;

            if(!nome || !bairro || !endereco) { alert("‚ö†Ô∏è Nome, Bairro e Endere√ßo s√£o obrigat√≥rios!"); return; }

            const pegarSelecionados = (classe) => {
                const marcados = Array.from(document.querySelectorAll('.' + classe + ':checked'));
                return marcados.length === 0 ? 'Nenhum' : marcados.map(cb => cb.value).join(', ');
            };

            const novoPedido = {
                numero: contadorComanda, nome: nome, telefone: telefone, bairro: bairro, endereco: endereco, tamanho: tamanho,
                base: pegarSelecionados('chk-base'), prot: pegarSelecionados('chk-prot'), croc: pegarSelecionados('chk-croc'),
                folha: pegarSelecionados('chk-folha'), toque: pegarSelecionados('chk-toque'), molho: pegarSelecionados('chk-molho'),
                status: 'col-novos', timestamp: Date.now()
            };

            push(ref(db, 'pedidos'), novoPedido);
            set(ref(db, 'contador'), contadorComanda + 1);

            document.getElementById('nome').value = ''; document.getElementById('telefone').value = '';
            document.getElementById('bairro').value = ''; document.getElementById('endereco').value = '';
            document.getElementById('tamanho').value = 'Copo 550ml';
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            document.getElementById('nome').focus(); 

            // Feedback Visual ao Enviar
            const btn = document.querySelector('.btn-add');
            const txtOriginal = btn.innerHTML;
            btn.innerHTML = "‚úîÔ∏è Enviado!";
            btn.style.background = "var(--verde-whats)";
            setTimeout(() => { btn.innerHTML = txtOriginal; btn.style.background = "var(--primaria)"; }, 1500);
        };

        window.moverPedido = function(idBanco, novoStatus) {
            update(ref(db, 'pedidos/' + idBanco), { status: novoStatus });
            if(novoStatus === 'col-rota') delete estadoCartoes[idBanco]; 
        };

        window.removerPedido = function(idBanco) {
            if(confirm("Deseja excluir este pedido?")) remove(ref(db, 'pedidos/' + idBanco));
        };

        window.zerarPainel = function() {
            if(confirm("‚ö†Ô∏è Aten√ß√£o: Isso apaga todos os pedidos de TODOS OS APARELHOS. Finalizar o dia?")) {
                set(ref(db, 'pedidos'), null); set(ref(db, 'contador'), 1);
            }
        };

        window.toggleMinimizar = function(idBanco) {
            const card = document.getElementById(idBanco);
            card.classList.toggle('minimizado');
            estadoCartoes[idBanco] = card.classList.contains('minimizado') ? 'fechado' : 'aberto';
        };

        // L√ìGICA DAS ABAS (MOBILE)
        window.mudarAba = function(idView, idTab) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('ativa'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('ativa'));
            
            document.getElementById(idView).classList.add('ativa');
            document.getElementById(idTab).classList.add('ativa');
        };

        // M√ÅSCARAS E TEMA
        document.getElementById('telefone').addEventListener('input', function (e) {
            let x = e.target.value.replace(/\D/g, '').match(/(\d{0,2})(\d{0,5})(\d{0,4})/);
            e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
        });

        document.querySelectorAll('.chk-base').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                if(document.querySelectorAll('.chk-base:checked').length > 2) {
                    this.checked = false; alert("Aten√ß√£o: M√°ximo de 2 op√ß√µes na Base.");
                }
            });
        });

        window.toggleTema = function() {
            const body = document.body;
            const isDark = body.getAttribute('data-theme') === 'dark';
            if(isDark) { body.removeAttribute('data-theme'); localStorage.setItem('isaTema', 'light'); } 
            else { body.setAttribute('data-theme', 'dark'); localStorage.setItem('isaTema', 'dark'); }
        };

        if(localStorage.getItem('isaTema') === 'dark') document.body.setAttribute('data-theme', 'dark');
    </script>
</body>
</html>
