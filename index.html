<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV √çsa no Copo - Entregas e Montagem</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --primaria: #10b981;
            --primaria-hover: #059669;
            --fundo-body: #f3f4f6;
            --fundo-card: #ffffff;
            --fundo-coluna: #f8fafc;
            --texto-principal: #1f2937;
            --texto-secundario: #4b5563;
            --borda: #e5e7eb;
            --borda-foco: #a7f3d0;
            --fundo-input: #f9fafb;
            --laranja: #f59e0b;
            --vermelho: #ef4444;
            --vermelho-fundo: #fef2f2;
            --azul: #3b82f6;
            --verde-whats: #25D366;
            --tag-bairro-bg: #fef3c7;
            --tag-bairro-text: #b45309;
            --lista-bg: #ecfdf5;
            --lista-text: #047857;
            --sombra: 0 4px 6px -1px rgba(0,0,0,0.05);
        }

        [data-theme="dark"] {
            --fundo-body: #0f172a;
            --fundo-card: #1e293b;
            --fundo-coluna: #0f172a;
            --texto-principal: #f8fafc;
            --texto-secundario: #94a3b8;
            --borda: #334155;
            --borda-foco: #059669;
            --fundo-input: #0f172a;
            --vermelho-fundo: #450a0a;
            --tag-bairro-bg: #78350f;
            --tag-bairro-text: #fde68a;
            --lista-bg: #064e3b;
            --lista-text: #6ee7b7;
            --sombra: 0 4px 6px -1px rgba(0,0,0,0.3);
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--fundo-body); color: var(--texto-principal); margin: 0; padding: 0; transition: 0.3s; }

        header { background: var(--fundo-card); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--borda); position: sticky; top: 0; z-index: 100; }
        header h1 { margin: 0; font-size: 20px; color: var(--primaria); display: flex; align-items: center; gap: 10px; }
        .controles-header { display: flex; gap: 10px; align-items: center;}

        .status-nuvem { font-size: 12px; font-weight: bold; color: var(--primaria); display: flex; align-items: center; gap: 5px; background: var(--lista-bg); padding: 5px 10px; border-radius: 20px;}
        .status-nuvem span { display: inline-block; width: 8px; height: 8px; background: var(--primaria); border-radius: 50%; animation: piscar 2s infinite; }
        @keyframes piscar { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        .btn-acao { background: var(--fundo-card); color: var(--texto-principal); border: 1px solid var(--borda); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; transition: 0.2s; }
        .btn-acao:hover { background: var(--fundo-body); }
        .btn-limpar { color: var(--vermelho); border-color: var(--vermelho); }
        .btn-limpar:hover { background: var(--vermelho-fundo); }

        .container { padding: 25px; max-width: 1400px; margin: auto; }

        .pdv-container { background: var(--fundo-card); padding: 25px; border-radius: 12px; box-shadow: var(--sombra); margin-bottom: 30px; border: 1px solid var(--borda); }
        .pdv-titulo { font-size: 16px; color: var(--texto-principal); margin-top: 0; border-bottom: 1px solid var(--borda); padding-bottom: 10px; margin-bottom: 20px; text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px; }

        .dados-cliente { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 25px; }
        .input-group { display: flex; flex-direction: column; flex: 1; min-width: 180px; }
        .input-group label { font-size: 13px; font-weight: 600; color: var(--texto-secundario); margin-bottom: 6px; }
        .dados-cliente input, .dados-cliente select { padding: 12px 15px; border: 1px solid var(--borda); border-radius: 8px; font-size: 14px; background-color: var(--fundo-input); color: var(--texto-principal); transition: 0.2s; }
        .dados-cliente input:focus, .dados-cliente select:focus { outline: none; border-color: var(--primaria); box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1); }

        .cardapio-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(230px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .categoria-menu { background: var(--fundo-body); border: 1px solid var(--borda); border-radius: 10px; padding: 15px; }
        .categoria-menu h4 { margin: 0 0 12px 0; font-size: 13px; color: var(--texto-secundario); font-weight: 700; text-transform: uppercase; }

        .chips-container { display: flex; flex-wrap: wrap; gap: 8px; }
        .chip-label { position: relative; display: inline-block; cursor: pointer; user-select: none; }
        .chip-label input { display: none; }
        .chip-label span { display: inline-block; padding: 8px 12px; border-radius: 20px; border: 1px solid var(--borda); font-size: 13px; background: var(--fundo-card); color: var(--texto-secundario); font-weight: 500; transition: 0.2s; }
        .chip-label input:checked + span { background: var(--primaria); color: white; border-color: var(--primaria); box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3); }

        .rodape-pdv { display: flex; justify-content: flex-end; border-top: 1px solid var(--borda); padding-top: 20px; }
        .btn-add { background: var(--primaria); color: white; border: none; padding: 15px 35px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 16px; transition: 0.2s; box-shadow: 0 4px 6px rgba(16, 185, 129, 0.2); }
        .btn-add:hover { background: var(--primaria-hover); transform: translateY(-2px); }

        .kanban-board { display: flex; gap: 20px; overflow-x: auto; padding-bottom: 20px; min-height: 50vh; }
        .kanban-col { background: var(--fundo-coluna); border-radius: 12px; width: 340px; min-width: 340px; padding: 15px; display: flex; flex-direction: column; gap: 15px; border: 1px solid var(--borda); }
        .kanban-col h3 { margin: 0 0 10px 0; font-size: 14px; font-weight: 700; padding-bottom: 10px; border-bottom: 2px solid var(--borda); text-transform: uppercase; color: var(--texto-principal); }

        .pedido-card { background: var(--fundo-card); padding: 15px; border-radius: 10px; box-shadow: var(--sombra); border: 1px solid var(--borda); border-left: 5px solid var(--laranja); transition: 0.3s; display: flex; flex-direction: column; gap: 10px; }

        .card-topo { cursor: pointer; display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 5px; }
        .id-pedido { font-size: 18px; font-weight: 900; color: var(--texto-secundario); margin-right: 8px; }
        .bairro-tag { display: inline-block; background: var(--tag-bairro-bg); color: var(--tag-bairro-text); padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; margin-bottom: 6px; text-transform: uppercase; }
        .card-topo h4 { margin: 0; font-size: 16px; font-weight: 700; color: var(--texto-principal); }
        .icone-toggle { color: var(--texto-secundario); font-size: 12px; transition: 0.3s; padding-top: 5px; }

        .card-detalhes { overflow: hidden; transition: max-height 0.3s ease; }
        .pedido-card.minimizado .card-detalhes { display: none; }
        .pedido-card.minimizado .icone-toggle { transform: rotate(-90deg); }

        .card-detalhes p { margin: 4px 0; font-size: 13px; color: var(--texto-secundario); line-height: 1.4; }
        .card-detalhes p strong { color: var(--texto-principal); }

        .lista-montagem { background: var(--lista-bg); padding: 12px; border-radius: 8px; margin: 10px 0; font-size: 13px; line-height: 1.6; color: var(--lista-text); border: 1px solid var(--borda-foco); }
        .lista-montagem span { display: block; border-bottom: 1px dashed rgba(16, 185, 129, 0.3); padding-bottom: 4px; margin-bottom: 4px; }
        .lista-montagem span:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }

        .grid-botoes-contato { display: flex; gap: 8px; margin-top: 10px; }
        .btn-link { flex: 1; display: flex; justify-content: center; align-items: center; gap: 5px; text-decoration: none; padding: 8px; border-radius: 6px; font-size: 12px; font-weight: 600; transition: 0.2s; border: 1px solid transparent; }
        .btn-mapa { background: rgba(59, 130, 246, 0.1); color: var(--azul); border-color: rgba(59, 130, 246, 0.2); }
        .btn-mapa:hover { background: var(--azul); color: white; }
        .btn-whats { background: rgba(37, 211, 102, 0.1); color: var(--verde-whats); border-color: rgba(37, 211, 102, 0.2); }
        .btn-whats:hover { background: var(--verde-whats); color: white; }

        .acoes-card { display: flex; gap: 8px; padding-top: 5px; margin-top: 5px; border-top: 1px solid var(--borda); }
        .btn-mover { background: transparent; border: 1px solid var(--primaria); color: var(--primaria); padding: 10px; border-radius: 6px; cursor: pointer; flex: 1; font-size: 13px; font-weight: 600; transition: 0.2s; }
        .btn-mover:hover { background: var(--primaria); color: white; }
        .btn-remover { background: transparent; border: 1px solid var(--borda); color: var(--texto-secundario); padding: 10px; border-radius: 6px; cursor: pointer; transition: 0.2s; }
        .btn-remover:hover { background: var(--vermelho-fundo); color: var(--vermelho); border-color: var(--vermelho); }

        @media (max-width: 768px) {
            .dados-cliente { flex-direction: column; }
            header { flex-direction: column; gap: 15px; }
            .btn-add { width: 100%; }
        }
    </style>
</head>
<body>

    <header>
        <h1>ü•ó √çsa no Copo <span style="font-size: 14px; font-weight: 400; color: var(--texto-secundario);">| Opera√ß√£o Di√°ria</span></h1>
        <div class="controles-header">
            <div class="status-nuvem"><span></span> Online (Nuvem)</div>
            <button class="btn-acao" onclick="toggleTema()" id="btn-tema">üåô Escuro</button>
            <button class="btn-acao btn-limpar" onclick="zerarPainel()">üóëÔ∏è Finalizar Dia</button>
        </div>
    </header>

    <div class="container">
        <div class="pdv-container">
            <h3 class="pdv-titulo">üìã 1. Ficha do Cliente</h3>
            <div class="dados-cliente">
                <div class="input-group">
                    <label>Nome do Cliente</label>
                    <input type="text" id="nome" placeholder="Ex: Jo√£o" autocomplete="off">
                </div>
                <div class="input-group">
                    <label>WhatsApp (Opcional)</label>
                    <input type="tel" id="telefone" placeholder="(00) 00000-0000" maxlength="15">
                </div>
                <div class="input-group">
                    <label>Bairro</label>
                    <input type="text" id="bairro" placeholder="Ex: Centro" autocomplete="off">
                </div>
                <div class="input-group" style="flex: 2;">
                    <label>Endere√ßo e N√∫mero</label>
                    <input type="text" id="endereco" placeholder="Rua das Flores, 123" autocomplete="off">
                </div>
                <div class="input-group">
                    <label>Tamanho</label>
                    <select id="tamanho">
                        <option value="Copo 550ml">Copo 550ml</option>
                        <option value="Copo 750ml">Copo 750ml</option>
                    </select>
                </div>
            </div>

            <h3 class="pdv-titulo">ü•ó 2. Montagem da Salada</h3>
            <div class="cardapio-grid">
                <div class="categoria-menu">
                    <h4>1. Base (M√°x 2)</h4>
                    <div class="chips-container">
                        <label class="chip-label"><input type="checkbox" class="chk-base" value="Macarr√£o Gelado"><span>Macarr√£o (Fusilli)</span></label>
                        <label class="chip-label"><input type="checkbox" class="chk-base" value="Quinoa Real"><span>Quinoa Real</span></label>
                        <label class="chip-label"><input type="checkbox" class="chk-base" value="Milho Doce"><span>Milho Doce</span></label>
                        <label class="chip-label"><input type="checkbox" class="chk-base" value="Ervilhas Frescas"><span>Ervilhas</span></label>
                    </div>
                </div>
                <div class="categoria-menu">
                    <h4>2. Prote√≠na</h4>
                    <div class="chips-container">
                        <label class="chip-label"><input type="checkbox" class="chk-prot" value="Frango Desfiado"><span>Frango Desfiado</span></label>
                        <label class="chip-label"><input type="checkbox" class="chk-prot" value="Atum"><span>Atum</span></label>
                    </div>
                </div>
                <div class="categoria-menu">
                    <h4>3. Croc√¢ncia & Cor</h4>
                    <div class="chips-container">
                        <label class="chip-label"><input type="checkbox" class="chk-croc" value="Tomate Cereja"><span>Tomate Cereja</span></label>
                        <label class="chip-label"><input type="checkbox" class="chk-croc" value="Cenoura Ralada"><span>Cenoura Ralada</span></label>
                        <label class="chip-label"><input type="checkbox" class="chk-croc" value="Pepino Japon√™s"><span>Pepino</span></label>
                        <label class="chip-label"><input type="checkbox" class="chk-croc" value="Beterraba Ralada"><span>Beterraba</span></label>
                        <label class="chip-label"><input type="checkbox" class="chk-croc" value="Palmito"><span>Palmito</span></label>
                        <label class="chip-label"><input type="checkbox" class="chk-croc" value="Cogumelos"><span>Cogumelos</span></label>
                    </div>
                </div>
                <div class="categoria-menu">
                    <h4>4. Folhas Frescas</h4>
                    <div class="chips-container">
                        <label class="chip-label"><input type="checkbox" class="chk-folha" value="Mix de Alface"><span>Mix de Alface</span></label>
                        <label class="chip-label"><input type="checkbox" class="chk-folha" value="R√∫cula"><span>R√∫cula</span></label>
                        <label class="chip-label"><input type="checkbox" class="chk-folha" value="Repolho Verde/Roxo"><span>Repolho Colorido</span></label>
                        <label class="chip-label"><input type="checkbox" class="chk-folha" value="Acelga Crocante"><span>Acelga</span></label>
                    </div>
                </div>
                <div class="categoria-menu">
                    <h4>5. Toque Final</h4>
                    <div class="chips-container">
                        <label class="chip-label"><input type="checkbox" class="chk-toque" value="Linha√ßa Dourada"><span>Linha√ßa</span></label>
                        <label class="chip-label"><input type="checkbox" class="chk-toque" value="Mix de Gergelim"><span>Gergelim</span></label>
                        <label class="chip-label"><input type="checkbox" class="chk-toque" value="Sementes de Chia"><span>Chia</span></label>
                        <label class="chip-label"><input type="checkbox" class="chk-toque" value="Nozes Chilenas"><span>Nozes</span></label>
                        <label class="chip-label"><input type="checkbox" class="chk-toque" value="Castanha de Caju"><span>Castanha</span></label>
                    </div>
                </div>
                <div class="categoria-menu">
                    <h4>6. Molhos Artesanais</h4>
                    <div class="chips-container">
                        <label class="chip-label"><input type="checkbox" class="chk-molho" value="Mostarda e Mel"><span>Mostarda e Mel</span></label>
                        <label class="chip-label"><input type="checkbox" class="chk-molho" value="Ros√© Cl√°ssico"><span>Ros√© Cl√°ssico</span></label>
                        <label class="chip-label"><input type="checkbox" class="chk-molho" value="Iogurte com Ervas"><span>Iogurte c/ Ervas</span></label>
                    </div>
                </div>
            </div>

            <div class="rodape-pdv">
                <button class="btn-add" onclick="adicionarPedido()">‚ûï Lan√ßar Pedido na Nuvem</button>
            </div>
        </div>

        <div class="kanban-board">
            <div class="kanban-col" id="col-novos"><h3>üî¥ Lan√ßados (Fila)</h3></div>
            <div class="kanban-col" id="col-preparo"><h3>üü° Montando Copo</h3></div>
            <div class="kanban-col" id="col-rota"><h3>üîµ Em Rota</h3></div>
            <div class="kanban-col" id="col-entregue"><h3>üü¢ Entregues</h3></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, onValue, push, set, update, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCL5banCYijxDHRGxQcDZOmnUnHaS_8Omg",
            authDomain: "isa-no-copo-pdv.firebaseapp.com",
            databaseURL: "https://isa-no-copo-pdv-default-rtdb.firebaseio.com",
            projectId: "isa-no-copo-pdv",
            storageBucket: "isa-no-copo-pdv.firebasestorage.app",
            messagingSenderId: "386835506265",
            appId: "1:386835506265:web:154cafa56da36ca14afd48",
            measurementId: "G-YLNN7Q81DV"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getDatabase(app);

        // Estado local para lembrar quais cart√µes voc√™ abriu/fechou manualmente
        let estadoCartoes = {};
        let contadorComanda = 1;

        // Monitora o contador em tempo real
        onValue(ref(db, 'contador'), (snapshot) => {
            contadorComanda = snapshot.val() || 1;
        });

        // =======================================================
        // DESENHAR CART√ïES EM TEMPO REAL (M√ÅGICA DO SINCRONISMO)
        // =======================================================
        onValue(ref(db, 'pedidos'), (snapshot) => {
            // 1. Limpa as colunas atuais
            document.getElementById('col-novos').innerHTML = '<h3>üî¥ Lan√ßados (Fila)</h3>';
            document.getElementById('col-preparo').innerHTML = '<h3>üü° Montando Copo</h3>';
            document.getElementById('col-rota').innerHTML = '<h3>üîµ Em Rota</h3>';
            document.getElementById('col-entregue').innerHTML = '<h3>üü¢ Entregues</h3>';

            const pedidos = snapshot.val();
            if (!pedidos) return;

            // 2. Reconstr√≥i os cart√µes conforme est√£o na nuvem
            Object.entries(pedidos).forEach(([chaveBanco, ped]) => {
                const enderecoBusca = encodeURIComponent(`${ped.endereco}, ${ped.bairro}, Tupi Paulista - SP`);
                const linkMapa = `https://www.google.com/maps/search/?api=1&query=${enderecoBusca}`;

                let btnWhatsHTML = '';
                if(ped.telefone && ped.telefone.length >= 14) {
                    const numLimpo = ped.telefone.replace(/\D/g, '');
                    const msgWhats = encodeURIComponent(`Ol√° ${ped.nome}! Seu pedido da √çsa no Copo acabou de sair para entrega e est√° a caminho! ü•óüõµ`);
                    const linkWhats = `https://wa.me/55${numLimpo}?text=${msgWhats}`;
                    const displayWhats = (ped.status === 'col-rota') ? 'flex' : 'none';
                    btnWhatsHTML = `<a href="${linkWhats}" target="_blank" class="btn-link btn-whats" style="display: ${displayWhats};">üí¨ Avisar Sa√≠da</a>`;
                }

                // Define regras baseadas na coluna
                let btnMoverHTML = '';
                let corBorda = '';
                let minimizarPadrao = false;

                if(ped.status === 'col-novos') {
                    btnMoverHTML = `<button class="btn-mover" onclick="moverPedido('${chaveBanco}', 'col-preparo')">Avan√ßar Etapa ‚ûî</button>`;
                    corBorda = 'var(--laranja)';
                    minimizarPadrao = false;
                } else if (ped.status === 'col-preparo') {
                    btnMoverHTML = `<button class="btn-mover" onclick="moverPedido('${chaveBanco}', 'col-rota')">Saiu p/ Entrega ‚ûî</button>`;
                    corBorda = 'var(--laranja)';
                    minimizarPadrao = true;
                } else if (ped.status === 'col-rota') {
                    btnMoverHTML = `<button class="btn-mover" style="background: var(--primaria); color: white;" onclick="moverPedido('${chaveBanco}', 'col-entregue')">Finalizar ‚úîÔ∏è</button>`;
                    corBorda = 'var(--azul)';
                    minimizarPadrao = false; // Abre autom√°tico na rota para mostrar o bot√£o do whats
                } else if (ped.status === 'col-entregue') {
                    corBorda = 'var(--primaria)';
                    minimizarPadrao = true;
                }

                // Verifica se o usu√°rio abriu/fechou manualmente neste celular
                let classeMinimizado = minimizarPadrao ? 'minimizado' : '';
                if (estadoCartoes[chaveBanco] === 'aberto') classeMinimizado = '';
                if (estadoCartoes[chaveBanco] === 'fechado') classeMinimizado = 'minimizado';
                let opacidade = (ped.status === 'col-entregue') ? '0.5' : '1';

                const cardHTML = `
                    <div class="pedido-card ${classeMinimizado}" id="${chaveBanco}" style="border-left-color: ${corBorda}; opacity: ${opacidade};">
                        <div class="card-topo" onclick="toggleMinimizar('${chaveBanco}')" title="Clique para ocultar/mostrar detalhes">
                            <div style="display: flex; align-items: center;">
                                <span class="id-pedido">#${ped.numero}</span>
                                <div>
                                    <span class="bairro-tag">üìç ${ped.bairro}</span>
                                    <h4>${ped.nome}</h4>
                                </div>
                            </div>
                            <span class="icone-toggle">‚ñº</span>
                        </div>

                        <div class="card-detalhes">
                            <p><strong>Tamanho:</strong> ${ped.tamanho}</p>
                            ${ped.telefone ? `<p><strong>WhatsApp:</strong> ${ped.telefone}</p>` : ''}

                            <div class="lista-montagem">
                                <span><strong>1. Base:</strong> ${ped.base}</span>
                                <span><strong>2. Prote√≠na:</strong> ${ped.prot}</span>
                                <span><strong>3. Croc√¢ncia:</strong> ${ped.croc}</span>
                                <span><strong>4. Folhas:</strong> ${ped.folha}</span>
                                <span><strong>5. Toques:</strong> ${ped.toque}</span>
                                <span><strong>Molhos:</strong> ${ped.molho}</span>
                            </div>

                            <p><strong>End:</strong> ${ped.endereco}</p>

                            <div class="grid-botoes-contato">
                                <a href="${linkMapa}" target="_blank" class="btn-link btn-mapa">üó∫Ô∏è Abrir Maps</a>
                                ${btnWhatsHTML}
                            </div>
                        </div>

                        <div class="acoes-card" style="display: ${ped.status === 'col-entregue' ? 'none' : 'flex'}">
                            ${btnMoverHTML}
                            <button class="btn-remover" onclick="removerPedido('${chaveBanco}')" title="Excluir">üóëÔ∏è</button>
                        </div>
                        ${ped.status === 'col-entregue' ? `<button class="btn-remover" style="margin-top:10px" onclick="removerPedido('${chaveBanco}')">üóëÔ∏è Limpar Pedido Entregue</button>` : ''}
                    </div>
                `;

                document.getElementById(ped.status).innerHTML += cardHTML;
            });
        });

        // =======================================================
        // FUN√á√ïES GLOBAIS (INTERA√á√ÉO COM O BANCO)
        // =======================================================

        window.adicionarPedido = function() {
            const nome = document.getElementById('nome').value;
            const telefone = document.getElementById('telefone').value;
            const bairro = document.getElementById('bairro').value;
            const endereco = document.getElementById('endereco').value;
            const tamanho = document.getElementById('tamanho').value;

            if(!nome || !bairro || !endereco) {
                alert("‚ö†Ô∏è Nome, Bairro e Endere√ßo s√£o obrigat√≥rios!");
                return;
            }

            const pegarSelecionados = (classe) => {
                const marcados = Array.from(document.querySelectorAll('.' + classe + ':checked'));
                return marcados.length === 0 ? 'Nenhum' : marcados.map(cb => cb.value).join(', ');
            };

            const novoPedido = {
                numero: contadorComanda,
                nome: nome,
                telefone: telefone,
                bairro: bairro,
                endereco: endereco,
                tamanho: tamanho,
                base: pegarSelecionados('chk-base'),
                prot: pegarSelecionados('chk-prot'),
                croc: pegarSelecionados('chk-croc'),
                folha: pegarSelecionados('chk-folha'),
                toque: pegarSelecionados('chk-toque'),
                molho: pegarSelecionados('chk-molho'),
                status: 'col-novos',
                timestamp: Date.now()
            };

            // Envia pra nuvem e atualiza o contador
            push(ref(db, 'pedidos'), novoPedido);
            set(ref(db, 'contador'), contadorComanda + 1);

            // Limpa o formul√°rio
            document.getElementById('nome').value = '';
            document.getElementById('telefone').value = '';
            document.getElementById('bairro').value = '';
            document.getElementById('endereco').value = '';
            document.getElementById('tamanho').value = 'Copo 550ml';
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            document.getElementById('nome').focus();
        };

        window.moverPedido = function(idBanco, novoStatus) {
            update(ref(db, 'pedidos/' + idBanco), { status: novoStatus });
            // Se movermos para uma coluna que abre autom√°tico, resetamos o estado local
            if(novoStatus === 'col-rota') delete estadoCartoes[idBanco];
        };

        window.removerPedido = function(idBanco) {
            if(confirm("Deseja cancelar/excluir este pedido?")) {
                remove(ref(db, 'pedidos/' + idBanco));
            }
        };

        window.zerarPainel = function() {
            if(confirm("‚ö†Ô∏è Aten√ß√£o: Isso apaga todos os pedidos de TODOS OS APARELHOS e reseta as comandas para o #1. Finalizar o dia?")) {
                set(ref(db, 'pedidos'), null);
                set(ref(db, 'contador'), 1);
            }
        };

        window.toggleMinimizar = function(idBanco) {
            const card = document.getElementById(idBanco);
            card.classList.toggle('minimizado');
            // Lembra a prefer√™ncia no navegador atual para n√£o fechar quando a nuvem atualizar
            estadoCartoes[idBanco] = card.classList.contains('minimizado') ? 'fechado' : 'aberto';
        };

        // =======================================================
        // C√ìDIGOS LOCAIS (M√ÅSCARAS E TEMAS)
        // =======================================================

        document.getElementById('telefone').addEventListener('input', function (e) {
            let x = e.target.value.replace(/\D/g, '').match(/(\d{0,2})(\d{0,5})(\d{0,4})/);
            e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
        });

        document.querySelectorAll('.chk-base').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const selecionados = document.querySelectorAll('.chk-base:checked').length;
                if(selecionados > 2) {
                    this.checked = false;
                    alert("Aten√ß√£o: M√°ximo de 2 op√ß√µes na Base.");
                }
            });
        });

        window.toggleTema = function() {
            const body = document.body;
            const btn = document.getElementById('btn-tema');
            if(body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                btn.innerHTML = 'üåô Escuro';
                localStorage.setItem('isaTema', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                btn.innerHTML = '‚òÄÔ∏è Claro';
                localStorage.setItem('isaTema', 'dark');
            }
        };

        // Carrega tema salvo no celular
        const temaSalvo = localStorage.getItem('isaTema');
        if(temaSalvo === 'dark') {
            document.body.setAttribute('data-theme', 'dark');
            document.getElementById('btn-tema').innerHTML = '‚òÄÔ∏è Claro';
        }

    </script>
</body>
</html>
